<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åå¤å±‹ç­†è¨˜ 2026</title>
    
    <!-- Google Fonts: Zen Maru Gothic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Leaflet CSS (For Maps) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        /* ================== é¢¨æ ¼å®šç¾© ================== */
        :root {
            --paper-color: #fcfcfc;
            --ink-color: #1a1a1a;
            --accent-orange: #f97316;
            --accent-pink: #ec4899;
            --accent-yellow: #eab308;
            --shadow-offset: 3px;
        }

        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: #f0f0f0;
            background-image: 
                linear-gradient(#e5e5e5 1px, transparent 1px),
                linear-gradient(90deg, #e5e5e5 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--ink-color);
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none; /* Prevent pull-to-refresh */
        }

        .app-shell {
            max-width: 480px;
            margin: 0 auto;
            background: var(--paper-color);
            min-height: 100vh;
            border-left: 2px solid #1a1a1a;
            border-right: 2px solid #1a1a1a;
            position: relative;
            padding-bottom: 90px;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* å¡—é´‰å¡ç‰‡é¢¨æ ¼ */
        .sketch-card {
            background: white;
            border: 2px solid var(--ink-color);
            border-radius: 12px;
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0px 0px var(--ink-color);
            transition: transform 0.1s, box-shadow 0.1s;
        }
        
        .sketch-card:active {
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0px 0px var(--ink-color);
        }

        /* ä¸å¯é»æ“Šçš„å¡ç‰‡ */
        .sketch-box {
            background: white;
            border: 2px solid var(--ink-color);
            border-radius: 12px;
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0px 0px rgba(0,0,0,0.1);
        }

        /* è¼¸å…¥æ¡†é¢¨æ ¼ */
        .sketch-input {
            border: 2px solid var(--ink-color);
            border-radius: 8px;
            outline: none;
            box-shadow: inset 2px 2px 4px rgba(0,0,0,0.05);
            transition: background 0.2s;
        }
        .sketch-input:focus {
            background-color: #fffbeb;
        }

        /* å°è¦½åˆ— */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 476px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            border-top: 2px solid var(--ink-color);
            display: flex;
            justify-content: space-around;
            padding: 10px 0 20px;
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-weight: 700;
            font-size: 0.7rem;
            transition: all 0.2s;
            position: relative;
        }

        .nav-item i {
            font-size: 1.25rem;
            margin-bottom: 2px;
        }

        .nav-item.active {
            color: var(--ink-color);
            transform: translateY(-2px);
        }
        
        /* é é¢åˆ‡æ› */
        .page-content {
            display: none;
            animation: fadeIn 0.3s ease-out;
            padding: 1.5rem;
            padding-bottom: 6rem;
        }
        .page-content.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Timeline Styles */
        .timeline-line {
            position: absolute;
            left: 24px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: repeating-linear-gradient(to bottom, var(--ink-color), var(--ink-color) 6px, transparent 6px, transparent 12px);
            z-index: 0;
        }

        /* SVG Map Styles */
        .path-line {
            stroke-dasharray: 8, 4;
            stroke-dashoffset: 1000;
            animation: drawLine 4s forwards ease-in-out;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        @keyframes drawLine { to { stroke-dashoffset: 0; } }
        
        .station-label {
            text-shadow: 2px 2px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;
            font-family: 'Zen Maru Gothic', sans-serif;
        }

        .map-container {
            position: relative;
            width: 100%;
            height: 400px;
            background-color: #fffbeb; 
            background-image: radial-gradient(#d6d3d1 1px, transparent 1px);
            background-size: 20px 20px;
            border: 2px solid var(--ink-color);
            border-radius: 12px;
            overflow: hidden;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        /* Map Embed */
        .map-frame {
            width: 100%;
            height: 200px;
            border: 2px solid var(--ink-color);
            border-radius: 12px;
            overflow: hidden;
            margin-top: 10px;
        }

        /* Expense Row */
        .expense-row {
            border-bottom: 1px dashed #ccc;
            padding: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .expense-row:last-child { border-bottom: none; }
        
        /* Stickman Animation */
        .stickman-arm {
            transform-origin: 25px 20px; 
            animation: waveArm 0.6s ease-in-out infinite alternate;
        }
        @keyframes waveArm {
            from { transform: rotate(-10deg); }
            to { transform: rotate(25deg); }
        }

        /* Utilities */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>

    <!-- Shared SVG Defs -->
    <svg width="0" height="0" style="position:absolute">
        <defs>
            <marker id="arrow-blue" markerWidth="5" markerHeight="5" refX="4" refY="2.5" orient="auto" markerUnits="strokeWidth">
                <path d="M0,0 L5,2.5 L0,5" fill="none" stroke="#38bdf8" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </marker>
            <marker id="arrow-pink" markerWidth="5" markerHeight="5" refX="4" refY="2.5" orient="auto" markerUnits="strokeWidth">
                <path d="M0,0 L5,2.5 L0,5" fill="none" stroke="#ec4899" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </marker>
            <marker id="arrow-green" markerWidth="5" markerHeight="5" refX="4" refY="2.5" orient="auto" markerUnits="strokeWidth">
                <path d="M0,0 L5,2.5 L0,5" fill="none" stroke="#4ade80" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </marker>
            <filter id="dropShadow" x="-20%" y="-20%" width="140%" height="140%">
                <feGaussianBlur in="SourceAlpha" stdDeviation="1"/>
                <feOffset dx="1" dy="1" result="offsetblur"/>
                <feComponentTransfer><feFuncA type="linear" slope="0.3"/></feComponentTransfer>
                <feMerge><feMergeNode/><feMergeNode in="SourceGraphic"/></feMerge>
            </filter>
        </defs>
    </svg>

    <div class="app-shell">
        
        <!-- HEADER (Shared) -->
        <div class="sticky top-0 bg-white/95 border-b-2 border-dashed border-gray-300 z-40 p-4 flex justify-between items-center backdrop-blur-sm">
            <div>
                <h1 class="text-2xl font-black tracking-tight flex items-center gap-2">
                    <span>åå¤å±‹</span>
                    <span class="text-xs bg-black text-white px-2 py-1 rounded rotate-3 inline-block">2026</span>
                </h1>
                <p class="text-[10px] font-bold text-gray-500 mt-0.5">03.02 - 03.06</p>
            </div>
            <div id="page-title-icon" class="w-10 h-10 border-2 border-black rounded-full flex items-center justify-center bg-yellow-400 shadow-[2px_2px_0_0_#000]">
                <i class="fas fa-plane"></i>
            </div>
        </div>

        <!-- ================= PAGE: PLAN (è¡Œç¨‹è¡¨) ================= -->
        <div id="page-plan" class="page-content active">
            
            <!-- Flight Info -->
            <div class="sketch-box p-3 bg-blue-50 mb-6 flex justify-between items-center">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="bg-blue-600 text-white text-[10px] px-1 rounded">å»ç¨‹</span>
                        <span class="text-xs font-bold">IT 778 (3/02)</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="bg-orange-500 text-white text-[10px] px-1 rounded">å›ç¨‹</span>
                        <span class="text-xs font-bold">IT 779 (3/06)</span>
                    </div>
                </div>
                <div class="text-2xl opacity-20"><i class="fas fa-plane-departure"></i></div>
            </div>

            <!-- Accommodation -->
            <div class="sketch-card p-3 mb-6 flex items-center gap-3">
                <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center border border-black">
                    <i class="fas fa-bed"></i>
                </div>
                <div class="flex-1">
                    <h3 class="font-bold text-sm">Trip & Sleep Hostel</h3>
                    <p class="text-[10px] text-gray-500">å¤§é ˆ/ä¸Šå‰æ´¥å€åŸŸ</p>
                </div>
                <a href="https://www.google.com/maps/search/?api=1&query=Trip+and+Sleep+Hostel+Nagoya" target="_blank" class="text-xs border border-black px-2 py-1 rounded hover:bg-gray-100">
                    <i class="fas fa-map-marker-alt text-red-500"></i> Map
                </a>
            </div>

            <!-- Day Tabs -->
            <div class="flex gap-2 overflow-x-auto hide-scrollbar mb-4">
                <button onclick="switchDay('day1')" class="day-tab active bg-white border-2 border-black px-4 py-2 rounded-lg font-bold text-sm whitespace-nowrap shadow-[2px_2px_0_0_#000]">Day 1 (3/03)</button>
                <button onclick="switchDay('day2')" class="day-tab bg-gray-100 border-2 border-transparent px-4 py-2 rounded-lg font-bold text-sm whitespace-nowrap text-gray-500">Day 2 (3/04)</button>
                <button onclick="switchDay('day3')" class="day-tab bg-gray-100 border-2 border-transparent px-4 py-2 rounded-lg font-bold text-sm whitespace-nowrap text-gray-500">Day 3 (3/05)</button>
            </div>

            <!-- Day Content Container -->
            <div id="day-content">
                <!-- Content will be populated by JS -->
            </div>
        </div>

        <!-- ================= PAGE: GUIDE (æ·±åº¦å°è¦½) ================= -->
        <div id="page-guide" class="page-content">
            <h2 class="text-2xl font-black mb-4">æ·±åº¦å°è¦½ Guide</h2>
            
            <div class="space-y-6">
                <!-- Article: Nagoya Castle -->
                <article class="sketch-card p-4">
                    <div class="h-32 bg-gray-200 rounded-lg mb-3 flex items-center justify-center overflow-hidden relative">
                        <div class="text-4xl">ğŸ‹</div>
                        <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
                        <span class="absolute bottom-2 left-3 text-white font-bold">åå¤å±‹åŸ Nagoya Castle</span>
                    </div>
                    <h3 class="font-bold text-lg mb-2">å°¾å¼µå¾·å·å®¶çš„å±…åŸ</h3>
                    <p class="text-sm text-gray-600 leading-relaxed mb-3">
                        æ—¥æœ¬ä¸‰ååŸä¹‹ä¸€ï¼Œæœ€å¤§ç‰¹è‰²æ˜¯å¤©å®ˆé–£å±‹é ‚ä¸Šçš„å…©éš»é‡‘å…‰é–ƒé–ƒçš„ã€Œé‡‘é¯± (Kinshachi)ã€ï¼Œè±¡å¾µè‘—å¾·å·å®¶çš„å¨åš´ã€‚
                        <br><br>
                        å‹™å¿…åƒè§€ä¿®å¾©å¾Œçš„ã€Œæœ¬ä¸¸å¾¡æ®¿ã€ï¼Œå…§éƒ¨çš„å±é¢¨ç•«èˆ‡å»ºç¯‰å·¥è—æ¥µç›¡å¥¢è¯ï¼Œé‡ç¾äº†æ±Ÿæˆ¶æ™‚ä»£çš„å°‡è»å±…æ‰€é¢¨è²Œã€‚
                    </p>
                    <div class="bg-gray-100 p-2 rounded text-xs border-l-4 border-yellow-400">
                        <strong>ğŸ’¡ å¿…çœ‹ï¼š</strong>æœ¬ä¸¸å¾¡æ®¿çš„ã€Œè¡¨æ›¸é™¢ã€èˆ‡ã€Œä¸Šæ´›æ®¿ã€ã€‚
                    </div>
                </article>

                <!-- Article: Inuyama -->
                <article class="sketch-card p-4">
                    <div class="h-32 bg-gray-200 rounded-lg mb-3 flex items-center justify-center overflow-hidden relative">
                        <div class="text-4xl">ğŸ¯</div>
                        <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
                        <span class="absolute bottom-2 left-3 text-white font-bold">çŠ¬å±±åŸ Inuyama Castle</span>
                    </div>
                    <h3 class="font-bold text-lg mb-2">æ—¥æœ¬ç¾å­˜æœ€å¤è€å¤©å®ˆé–£</h3>
                    <p class="text-sm text-gray-600 leading-relaxed mb-3">
                        çŠ¬å±±åŸåˆ¥åã€Œç™½å¸åŸã€ï¼Œä½åœ¨æœ¨æ›¾å·ç•”çš„å°å±±ä¸˜ä¸Šã€‚å®ƒæ˜¯æ—¥æœ¬åœ‹å¯¶äº”åŸä¹‹ä¸€ï¼Œä¹Ÿæ˜¯ç¾å­˜å¤©å®ˆä¸­æœ€å¤è€çš„ä¸€åº§ã€‚ç™»é ‚å¾Œå¯ä»¥360åº¦ä¿¯ç°æœ¨æ›¾å·ç¾æ™¯ã€‚
                    </p>
                    <div class="bg-gray-100 p-2 rounded text-xs border-l-4 border-pink-400">
                        <strong>ğŸ’¡ å†·çŸ¥è­˜ï¼š</strong>æ“šèªªåŸä¸»æˆç€¨å®¶ä¸€ç›´æ“æœ‰é€™åº§åŸç›´åˆ°2004å¹´ï¼Œæ˜¯æ—¥æœ¬æœ€å¾Œä¸€åº§å€‹äººæŒæœ‰çš„åŸå ¡ã€‚
                    </div>
                </article>

                <!-- Article: Osu -->
                <article class="sketch-card p-4">
                    <h3 class="font-bold text-lg mb-2 flex items-center"><i class="fas fa-map-marked-alt mr-2 text-blue-500"></i>å¤§é ˆè§€éŸ³èˆ‡å•†åº—è¡—</h3>
                    <p class="text-sm text-gray-600 mb-3">
                        é€™è£¡ä¸åƒ…æœ‰é¦™ç«é¼ç››çš„å¤§é ˆè§€éŸ³å¯ºï¼Œæ›´æ˜¯åå¤å±‹çš„æ¬¡æ–‡åŒ–ç™¼ä¿¡åœ°ï¼Œæœ‰è¨±å¤šå¤è‘—åº—ã€å‹•æ¼«å‘¨é‚Šåº—ï¼Œä»¥åŠç•°åœ‹ç¾é£Ÿã€‚
                    </p>
                    <!-- OpenStreetMap Embed -->
                    <div class="map-frame">
                        <iframe width="100%" height="100%" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="https://www.openstreetmap.org/export/embed.html?bbox=136.8970%2C35.1550%2C136.9080%2C35.1620&amp;layer=mapnik&amp;marker=35.1595%2C136.9030" style="border: 0"></iframe>
                    </div>
                    <small class="block text-right mt-1 text-[10px] text-gray-400">View on OpenStreetMap</small>
                </article>
            </div>
        </div>

        <!-- ================= PAGE: WALLET (è¨˜å¸³) ================= -->
        <div id="page-wallet" class="page-content">
            <h2 class="text-2xl font-black mb-4">è¨˜å¸³ & åŒ¯ç‡ Wallet</h2>

            <!-- Currency Converter / Calculator -->
            <div class="sketch-card p-4 bg-gray-800 text-white mb-6">
                <h3 class="text-xs font-bold text-gray-400 mb-2 uppercase">Quick Converter (Jpy â†’ Twd)</h3>
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-xl font-bold">Â¥</span>
                    <input type="text" id="calc-input" placeholder="è¼¸å…¥ç®—å¼ (å¦‚ 500*3)" class="w-full bg-transparent border-b border-gray-600 text-2xl font-mono focus:outline-none focus:border-yellow-400">
                </div>
                <div class="flex justify-between items-end">
                    <div class="text-xs text-gray-400">Rate: <span id="rate-display">0.215</span></div>
                    <div class="text-right">
                        <div class="text-3xl font-black text-yellow-400">NT$ <span id="calc-result">0</span></div>
                    </div>
                </div>
            </div>

            <!-- Expense Entry Form -->
            <div class="sketch-box p-4 bg-white mb-6">
                <div class="text-center text-sm font-bold text-gray-600 flex items-center justify-center gap-2 mb-4 bg-yellow-50 p-2 rounded border border-dashed border-yellow-300">
                    <span>ğŸ’¡ å¯ç”¨å°å¹£/æ—¥å¹£åƒ¹æ ¼è¼¸å…¥</span>
                    <svg width="24" height="24" viewBox="0 0 50 50" overflow="visible">
                        <circle cx="25" cy="10" r="5" fill="none" stroke="#4b5563" stroke-width="2"/>
                        <line x1="25" y1="15" x2="25" y2="35" stroke="#4b5563" stroke-width="2"/>
                        <line x1="25" y1="35" x2="18" y2="45" stroke="#4b5563" stroke-width="2"/>
                        <line x1="25" y1="35" x2="32" y2="45" stroke="#4b5563" stroke-width="2"/>
                        <line x1="25" y1="20" x2="15" y2="25" stroke="#4b5563" stroke-width="2"/>
                        <g class="stickman-arm">
                            <line x1="25" y1="20" x2="35" y2="10" stroke="#4b5563" stroke-width="2"/>
                            <rect x="32" y="2" width="14" height="8" fill="#86efac" stroke="#4b5563" stroke-width="1" transform="rotate(-15 32 10)"/>
                            <text x="39" y="9" font-size="6" font-weight="bold" fill="#065f46" text-anchor="middle" transform="rotate(-15 32 10)">Â¥</text>
                        </g>
                    </svg>
                </div>
                
                <div class="space-y-3">
                    <input type="text" id="expense-item" placeholder="å“é …åç¨± (å¦‚: æ™šé¤)" class="sketch-input w-full p-2">
                    
                    <div class="flex gap-2">
                        <!-- Category Select -->
                        <div class="relative w-1/3">
                            <select id="expense-category" class="sketch-input w-full p-2 appearance-none bg-white font-bold">
                                <option value="food">é£²é£Ÿ ğŸ´</option>
                                <option value="shopping">è³¼ç‰© ğŸ›ï¸</option>
                                <option value="transport">äº¤é€š ğŸšƒ</option>
                                <option value="accommodation">ä½å®¿ ğŸ›Œ</option>
                                <option value="other">å…¶ä»– âœ¨</option>
                            </select>
                            <i class="fas fa-chevron-down absolute right-2 top-3 text-xs pointer-events-none"></i>
                        </div>
                        
                        <!-- Currency Select -->
                        <div class="relative w-1/4">
                            <select id="expense-currency" class="sketch-input w-full p-2 appearance-none bg-white font-bold">
                                <option value="JPY">Â¥</option>
                                <option value="TWD">NT$</option>
                            </select>
                            <i class="fas fa-chevron-down absolute right-2 top-3 text-xs pointer-events-none"></i>
                        </div>

                        <!-- Amount Input -->
                        <input type="number" id="expense-amount" placeholder="é‡‘é¡" class="sketch-input flex-1 p-2 font-mono">
                    </div>

                    <!-- Photo Upload -->
                    <label class="flex items-center justify-center gap-2 border-2 border-dashed border-gray-300 rounded-lg p-2 cursor-pointer hover:bg-gray-50 transition">
                        <i class="fas fa-camera text-gray-400"></i>
                        <span class="text-sm text-gray-500" id="photo-label">ä¸Šå‚³ç…§ç‰‡ (é¸å¡«)</span>
                        <input type="file" id="expense-photo" accept="image/*" class="hidden" onchange="handlePhotoUpload(this)">
                    </label>
                    <input type="hidden" id="expense-photo-base64">

                    <button onclick="addExpense()" class="w-full bg-black text-white font-bold py-2 rounded-lg hover:bg-gray-800 transition shadow-[2px_2px_0_0_#ccc]">
                        è¨˜ä¸€ç­†
                    </button>
                </div>
            </div>

            <!-- Expense Categories List -->
            <div id="expenses-container" class="space-y-6 pb-20">
                <!-- Populated by JS -->
            </div>

            <!-- Total Sticky Footer -->
            <div class="fixed bottom-[70px] left-0 right-0 bg-gray-900 text-white p-4 mx-4 rounded-xl shadow-2xl z-50 border-2 border-white max-w-[448px] md:mx-auto">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="text-[10px] text-gray-400 uppercase tracking-widest">Total Expenses</div>
                        <div class="text-2xl font-black text-yellow-400">Â¥ <span id="total-jpy">0</span></div>
                    </div>
                    <div class="text-right">
                        <div class="text-[10px] text-gray-400">Approx. TWD</div>
                        <div class="text-lg font-bold">NT$ <span id="total-twd">0</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= PAGE: LISTS (æ¸…å–®) ================= -->
        <div id="page-lists" class="page-content">
            <h2 class="text-2xl font-black mb-4">æ¸…å–® Lists</h2>

            <!-- Checklist -->
            <div class="sketch-card p-4 mb-6 bg-yellow-50">
                <h3 class="font-bold mb-3 border-b-2 border-black pb-1"><i class="fas fa-check-square mr-2"></i>è¡Œå‰æº–å‚™</h3>
                <div id="checklist-container" class="space-y-2">
                    <!-- JS populated -->
                </div>
                <div class="mt-3 flex gap-2">
                    <input type="text" id="new-check-item" placeholder="æ–°å¢é …ç›®..." class="sketch-input flex-1 p-1 text-sm bg-white">
                    <button onclick="addCheckItem()" class="bg-black text-white w-8 rounded"><i class="fas fa-plus"></i></button>
                </div>
            </div>

            <!-- Memos -->
            <div class="sketch-card p-4 bg-white">
                <h3 class="font-bold mb-3 border-b-2 border-black pb-1"><i class="fas fa-sticky-note mr-2"></i>å€‹äººå‚™å¿˜éŒ„</h3>
                <textarea id="memo-area" class="w-full h-40 p-2 text-sm bg-gray-50 border border-gray-200 rounded resize-none focus:outline-none focus:bg-white" placeholder="è¼¸å…¥å‚™å¿˜ï¼Œç¶²å€æœƒè‡ªå‹•è®Šæˆé€£çµ..."></textarea>
                <div id="memo-links" class="mt-2 flex flex-wrap gap-2"></div>
            </div>
        </div>

        <!-- ================= PAGE: INFO (è³‡è¨Š) ================= -->
        <div id="page-info" class="page-content">
            <h2 class="text-2xl font-black mb-4">å¯¦ç”¨è³‡è¨Š Info</h2>

            <!-- Weather -->
            <div class="sketch-card p-4 mb-6 bg-gradient-to-br from-blue-100 to-white relative overflow-hidden">
                <h3 class="font-bold mb-2">åå¤å±‹å¤©æ°£ (Nagoya)</h3>
                <div id="weather-widget" class="flex items-center justify-between">
                    <div>
                        <div class="text-3xl font-black" id="temp-display">--Â°C</div>
                        <div class="text-sm text-gray-600" id="weather-desc">Loading...</div>
                    </div>
                    <div class="text-4xl opacity-50"><i class="fas fa-cloud-sun"></i></div>
                </div>
            </div>

            <!-- Emergency -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <a href="tel:110" class="sketch-box p-3 text-center bg-red-50 hover:bg-red-100">
                    <i class="fas fa-user-shield text-2xl text-red-500 mb-1"></i>
                    <div class="font-bold">è­¦å¯Ÿ 110</div>
                </a>
                <a href="tel:119" class="sketch-box p-3 text-center bg-red-50 hover:bg-red-100">
                    <i class="fas fa-ambulance text-2xl text-red-500 mb-1"></i>
                    <div class="font-bold">æ•‘è­· 119</div>
                </a>
            </div>

            <!-- Tips -->
            <div class="sketch-card p-4 bg-white">
                <h3 class="font-bold mb-2 text-red-500"><i class="fas fa-exclamation-triangle mr-2"></i>æ³¨æ„äº‹é …</h3>
                
                <!-- Clothing Recommendation (Added) -->
                <div class="mb-4 pb-3 border-b border-dashed border-gray-200">
                    <h4 class="font-bold text-sm mb-1 text-gray-800"><i class="fas fa-tshirt mr-1"></i>ç•¶æ—¥å»ºè­°ç©¿è‘— (3æœˆåˆ)</h4>
                    <p class="text-xs text-gray-600 leading-relaxed">
                        æ°£æº«ç´„ 5Â°C ~ 15Â°Cï¼Œæ—©æ™šæº«å·®å¤§ã€‚å»ºè­°æ¡ç”¨<strong>æ´‹è”¥å¼ç©¿æ­</strong>ï¼š
                        <br>ğŸ§¥ <strong>å¤–å¥—</strong>ï¼šé˜²é¢¨å¤§è¡£æˆ–è¼•ç¾½çµ¨ (æ—©æ™šå†·)ã€‚
                        <br>ğŸ‘• <strong>ä¸Šè¡£</strong>ï¼šç™¼ç†±è¡£ + é‡ç¹”è¡«/è¡›è¡£ã€‚
                        <br>ğŸ§£ <strong>é…ä»¶</strong>ï¼šåœå·¾ (é¢¨å¤§æ™‚å¥½ç”¨)ã€‚
                        <br>ğŸ‘Ÿ <strong>é‹å­</strong>ï¼šå¥½èµ°çš„çƒé‹ (è¡Œç¨‹å¤šèµ°è·¯)ã€‚
                    </p>
                </div>

                <ul class="text-sm list-disc pl-4 space-y-1 text-gray-600">
                    <li>æ—¥æœ¬é›»å£“ç‚º 100Vï¼Œæ’åº§ç‚ºé›™å¹³è…³ã€‚</li>
                    <li>è·¯ä¸Šç¦æ­¢å¸è¸ï¼Œè«‹è‡³æŒ‡å®šå¸è¸å€ã€‚</li>
                    <li>é›»è»Šå…§è«‹å°‡æ‰‹æ©Ÿè¨­ç‚ºéœéŸ³ï¼Œé¿å…é€šè©±ã€‚</li>
                    <li>çµå¸³æ™‚è«‹å°‡éŒ¢æ”¾åœ¨æ«ƒæª¯çš„å°ç›¤å­ä¸Šã€‚</li>
                </ul>
            </div>
        </div>

        <!-- BOTTOM NAVIGATION -->
        <nav class="bottom-nav">
            <button onclick="switchPage('page-plan')" id="nav-plan" class="nav-item active">
                <i class="fas fa-map-marked-alt"></i>
                <span class="mt-1">PLAN</span>
            </button>
            <button onclick="switchPage('page-guide')" id="nav-guide" class="nav-item">
                <i class="fas fa-book-open"></i>
                <span class="mt-1">GUIDE</span>
            </button>
            <button onclick="switchPage('page-wallet')" id="nav-wallet" class="nav-item">
                <i class="fas fa-wallet"></i>
                <span class="mt-1">WALLET</span>
            </button>
            <button onclick="switchPage('page-lists')" id="nav-lists" class="nav-item">
                <i class="fas fa-list-check"></i>
                <span class="mt-1">LISTS</span>
            </button>
            <button onclick="switchPage('page-info')" id="nav-info" class="nav-item">
                <i class="fas fa-info-circle"></i>
                <span class="mt-1">INFO</span>
            </button>
        </nav>

    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ================= STATE & CONFIG =================
        let exchangeRate = 0.215; // JPY to TWD (Will fetch)
        
        // Initial Data
        const defaultChecklist = [
            { text: "è­·ç…§", checked: false },
            { text: "ç¶²å¡ / Roaming", checked: false },
            { text: "æ—¥å¹£ç¾é‡‘", checked: false },
            { text: "è¡Œå‹•é›»æº", checked: false }
        ];

        const expenseCategories = [
            { id: 'food', name: 'é£²é£Ÿ', icon: 'fa-utensils', color: 'bg-orange-50', chartColor: '#fdba74' },
            { id: 'shopping', name: 'è³¼ç‰©', icon: 'fa-shopping-bag', color: 'bg-pink-50', chartColor: '#f9a8d4' },
            { id: 'transport', name: 'äº¤é€š', icon: 'fa-train', color: 'bg-blue-50', chartColor: '#93c5fd' },
            { id: 'accommodation', name: 'ä½å®¿', icon: 'fa-bed', color: 'bg-purple-50', chartColor: '#d8b4fe' },
            { id: 'other', name: 'å…¶ä»–', icon: 'fa-ellipsis-h', color: 'bg-gray-100', chartColor: '#d1d5db' }
        ];

        // ================= NAVIGATION =================
        function switchPage(pageId) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            window.scrollTo(0,0);
            
            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
            const navId = pageId.replace('page-', 'nav-');
            document.getElementById(navId).classList.add('active');

            const iconMap = {
                'page-plan': 'fa-plane',
                'page-guide': 'fa-book-open',
                'page-wallet': 'fa-coins',
                'page-lists': 'fa-list-check',
                'page-info': 'fa-info'
            };
            document.querySelector('#page-title-icon i').className = `fas ${iconMap[pageId]}`;
        }

        // ================= PLAN: DAY SWITCHER =================
        function switchDay(dayId) {
            document.querySelectorAll('.day-tab').forEach(btn => {
                if(btn.textContent.toLowerCase().includes(dayId.replace('day',''))) {
                    btn.classList.add('active', 'bg-white', 'border-black', 'shadow-[2px_2px_0_0_#000]', 'text-black');
                    btn.classList.remove('bg-gray-100', 'border-transparent', 'text-gray-500');
                } else {
                    btn.classList.remove('active', 'bg-white', 'border-black', 'shadow-[2px_2px_0_0_#000]', 'text-black');
                    btn.classList.add('bg-gray-100', 'border-transparent', 'text-gray-500');
                }
            });

            const contentDiv = document.getElementById('day-content');
            let html = '';

            if (dayId === 'day1') {
                html = `
                    <div id="day1-detail" class="day-detail">
                        <h3 class="font-black text-xl mb-4 border-l-4 border-blue-400 pl-3">å¸‚å€ç¾é£Ÿå·¡ç¦®</h3>
                        <div class="relative pl-2">
                            <div class="timeline-line"></div>
                            <div class="relative flex items-start mb-6"><div class="bg-white border-2 border-black w-8 h-8 rounded-full flex items-center justify-center z-10 mr-3 flex-shrink-0"><span class="font-bold text-xs">08:00</span></div><div class="sketch-card p-3 flex-1"><h4 class="font-bold">å‡ºç™¼ï¼</h4><p class="text-xs text-gray-500">Hostel é›†åˆ</p></div></div>
                            <div class="relative flex items-start mb-6"><div class="bg-orange-100 border-2 border-black w-8 h-8 rounded-full flex items-center justify-center z-10 mr-3 flex-shrink-0"><i class="fas fa-utensils text-xs"></i></div><div class="sketch-card p-3 flex-1"><h4 class="font-bold">Konparu (æ¦®)</h4><p class="text-xs text-gray-500">ç‚¸è¦ä¸‰æ˜æ²»æ—©é¤</p></div></div>
                            <div class="relative flex items-start mb-6"><div class="bg-blue-100 border-2 border-black w-8 h-8 rounded-full flex items-center justify-center z-10 mr-3 flex-shrink-0"><i class="fas fa-fish text-xs"></i></div><div class="sketch-box p-3 bg-blue-50 flex-1 border-dashed"><h4 class="font-bold">æŸ³æ©‹ä¸­å¤®å¸‚å ´</h4><p class="text-xs">ç”Ÿé­šç‰‡ã€æµ·é®®å·¡ç¦®</p></div></div>
                            <div class="relative flex items-start mb-6"><div class="bg-red-100 border-2 border-black w-8 h-8 rounded-full flex items-center justify-center z-10 mr-3 flex-shrink-0"><i class="fas fa-shopping-bag text-xs"></i></div><div class="sketch-card p-3 flex-1"><h4 class="font-bold">å¤§é ˆå•†åº—è¡—</h4><p class="text-xs text-gray-500">é€›è¡—ã€ä¸‹åˆèŒ¶</p></div></div>
                            <div class="relative flex items-start mb-6"><div class="bg-yellow-100 border-2 border-black w-8 h-8 rounded-full flex items-center justify-center z-10 mr-3 flex-shrink-0"><i class="fas fa-drumstick-bite text-xs"></i></div><div class="sketch-card p-3 flex-1 border-l-4 border-black"><h4 class="font-bold">ç†±ç”°è“¬èŠè»’ (æ™šé¤)</h4><p class="text-xs text-gray-500">å¿…åƒé°»é­šé£¯ä¸‰åƒ Hitsumabushi</p></div></div>
                        </div>
                        <div class="map-container">
                            <h4 class="absolute top-2 left-3 font-bold text-[10px] bg-white px-2 py-1 border border-black rounded z-10">Day 1 Route</h4>
                            <svg viewBox="0 0 350 400" class="w-full h-full">
                                <path d="M 120 0 Q 110 200 130 400" fill="none" stroke="#e0f2fe" stroke-width="20" stroke-linecap="round" />
                                <line x1="0" y1="200" x2="350" y2="200" stroke="#e5e5e5" stroke-width="12" />
                                <line x1="230" y1="0" x2="230" y2="400" stroke="#e5e5e5" stroke-width="12" />
                                <path d="M 60 0 L 60 400" fill="none" stroke="#777" stroke-width="2" stroke-dasharray="4,4" />
                                <path d="M 210 210 Q 250 150 240 80" fill="none" stroke="#38bdf8" stroke-width="4" stroke-dasharray="10,5" stroke-linecap="round" class="path-line" marker-end="url(#arrow-blue)" />
                                <path d="M 240 80 Q 150 50 60 80" fill="none" stroke="#38bdf8" stroke-width="4" stroke-dasharray="10,5" stroke-linecap="round" class="path-line" marker-end="url(#arrow-blue)" />
                                <path d="M 60 80 Q 80 150 120 200" fill="none" stroke="#38bdf8" stroke-width="4" stroke-dasharray="10,5" stroke-linecap="round" class="path-line" marker-end="url(#arrow-blue)" />
                                <path d="M 120 200 Q 150 300 180 350" fill="none" stroke="#38bdf8" stroke-width="4" stroke-dasharray="10,5" stroke-linecap="round" class="path-line" marker-end="url(#arrow-blue)" />
                                <path d="M 180 350 Q 220 300 210 210" fill="none" stroke="#38bdf8" stroke-width="4" stroke-dasharray="10,5" stroke-linecap="round" class="path-line" marker-end="url(#arrow-blue)" />
                                <text x="40" y="80" font-size="24" filter="url(#dropShadow)">ğŸš‰</text><text x="60" y="95" text-anchor="middle" font-size="10" font-weight="bold" class="station-label">åç«™</text>
                                <text x="220" y="80" font-size="24" filter="url(#dropShadow)">ğŸš‰</text><text x="240" y="95" text-anchor="middle" font-size="10" font-weight="bold" class="station-label">æ¦®</text>
                                <text x="100" y="200" font-size="24" filter="url(#dropShadow)">â›©ï¸</text><text x="120" y="220" text-anchor="middle" font-size="10" font-weight="bold" class="station-label">å¤§é ˆ</text>
                                <text x="160" y="350" font-size="24" filter="url(#dropShadow)">ğŸ±</text><text x="180" y="370" text-anchor="middle" font-size="10" font-weight="bold" class="station-label">ç†±ç”°</text>
                                <path d="M 190 200 Q 205 205 210 215" fill="none" stroke="black" stroke-width="1.5" stroke-dasharray="3,2" /><g transform="translate(210, 210)"><path d="M 0 15 L 15 0 L 30 15" fill="none" stroke="#1a1a1a" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" /><path d="M 5 15 L 5 30 L 25 30 L 25 15" fill="none" stroke="#1a1a1a" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" /><text x="15" y="45" text-anchor="middle" font-size="9" font-weight="bold" fill="#22c55e" class="station-label">ä½å®¿</text></g>
                                <text x="250" y="70" font-size="9" font-weight="bold" fill="#38bdf8" class="station-label">ç‚¸è¦ä¸‰æ˜æ²»</text>
                                <circle cx="240" cy="80" r="8" fill="#38bdf8" stroke="white" stroke-width="2" transform="translate(0,20)"/> <text x="240" y="104" text-anchor="middle" font-size="10" font-weight="bold" fill="white">1</text>
                                <circle cx="60" cy="80" r="8" fill="#38bdf8" stroke="white" stroke-width="2" transform="translate(0,-15)"/> <text x="60" y="69" text-anchor="middle" font-size="10" font-weight="bold" fill="white">2</text>
                                <circle cx="120" cy="200" r="8" fill="#38bdf8" stroke="white" stroke-width="2"/> <text x="120" y="204" text-anchor="middle" font-size="10" font-weight="bold" fill="white">3</text>
                                <circle cx="180" cy="350" r="8" fill="#38bdf8" stroke="white" stroke-width="2"/> <text x="180" y="354" text-anchor="middle" font-size="10" font-weight="bold" fill="white">4</text>
                            </svg>
                        </div>
                    </div>
                `;
            } else if (dayId === 'day2') {
                html = `
                    <div id="day2-detail" class="day-detail">
                        <h3 class="font-black text-xl mb-4 border-l-4 border-pink-400 pl-3">çŠ¬å±±åŸå¤éƒ½éŠ</h3>
                        <div class="relative pl-2">
                            <div class="timeline-line"></div>
                            <div class="relative flex items-start mb-6"><div class="bg-white border-2 border-black w-8 h-8 rounded-full flex items-center justify-center z-10 mr-3 flex-shrink-0"><span class="font-bold text-xs">08:00</span></div><div class="sketch-card p-3 flex-1"><h4 class="font-bold">Bucyo Coffee</h4><p class="text-xs text-gray-500">å°å€‰ç´…è±†åå¸</p></div></div>
                            <div class="relative flex items-start mb-6"><div class="bg-pink-100 border-2 border-black w-8 h-8 rounded-full flex items-center justify-center z-10 mr-3 flex-shrink-0"><i class="fas fa-chess-rook text-xs"></i></div><div class="sketch-card p-3 flex-1"><h4 class="font-bold">çŠ¬å±±åŸ</h4><p class="text-xs text-gray-500">åœ‹å¯¶å¤©å®ˆé–£ã€åŸä¸‹ç”ºæ•£ç­–</p></div></div>
                            <div class="relative flex items-start mb-6"><div class="bg-amber-100 border-2 border-black w-8 h-8 rounded-full flex items-center justify-center z-10 mr-3 flex-shrink-0"><i class="fas fa-coffee text-xs"></i></div><div class="sketch-card p-3 flex-1"><h4 class="font-bold">GOLPIE COFFEE</h4><p class="text-xs text-gray-500">å·åå±±å† è»å’–å•¡</p></div></div>
                            <div class="relative flex items-start mb-6"><div class="bg-gray-800 text-white border-2 border-black w-8 h-8 rounded-full flex items-center justify-center z-10 mr-3 flex-shrink-0"><i class="fas fa-beer text-xs"></i></div><div class="sketch-card p-3 flex-1"><h4 class="font-bold">ä¸–ç•Œçš„å±±å°‡</h4><p class="text-xs text-gray-500">å¤¢å¹»æ‰‹ç¾½å…ˆ</p></div></div>
                        </div>
                        <div class="map-container">
                            <h4 class="absolute top-2 left-3 font-bold text-[10px] bg-white px-2 py-1 border border-black rounded z-10">Day 2 Route</h4>
                            <svg viewBox="0 0 350 400" class="w-full h-full">
                                <path d="M 120 0 Q 110 200 130 400" fill="none" stroke="#e0f2fe" stroke-width="20" stroke-linecap="round" />
                                <path d="M 60 0 L 60 400" fill="none" stroke="#777" stroke-width="2" stroke-dasharray="4,4" />
                                <path d="M 210 350 Q 160 320 60 250" fill="none" stroke="#ec4899" stroke-width="3" stroke-dasharray="8,5" class="path-line" marker-end="url(#arrow-pink)" />
                                <path d="M 60 250 Q 60 150 180 50" fill="none" stroke="#ec4899" stroke-width="3" stroke-dasharray="8,5" class="path-line" marker-end="url(#arrow-pink)" />
                                <path d="M 180 50 Q 300 200 280 300" fill="none" stroke="#ec4899" stroke-width="3" stroke-dasharray="8,5" class="path-line" marker-end="url(#arrow-pink)" />
                                <path d="M 280 300 Q 250 340 210 350" fill="none" stroke="#ec4899" stroke-width="3" stroke-dasharray="8,5" class="path-line" marker-end="url(#arrow-pink)" />
                                <text x="160" y="50" font-size="24" filter="url(#dropShadow)">ğŸ¯</text><text x="205" y="50" font-size="12" font-weight="bold" class="station-label">çŠ¬å±±</text>
                                <text x="40" y="230" font-size="28" filter="url(#dropShadow)">ğŸš‰</text><text x="60" y="255" text-anchor="middle" font-size="10" font-weight="bold" class="station-label">åç«™</text>
                                <text x="270" y="280" font-size="18" filter="url(#dropShadow)">â˜•</text><text x="300" y="300" text-anchor="middle" font-size="10" font-weight="bold" class="station-label">Golpie</text>
                                <text x="160" y="330" font-size="28" filter="url(#dropShadow)">ğŸš‰</text><text x="180" y="355" text-anchor="middle" font-size="10" font-weight="bold" class="station-label">ä¸Šå‰æ´¥</text>
                                <path d="M 190 340 Q 205 345 210 355" fill="none" stroke="black" stroke-width="1.5" stroke-dasharray="3,2" /><g transform="translate(210, 350)"><path d="M 0 15 L 15 0 L 30 15" fill="none" stroke="#1a1a1a" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" /><path d="M 5 15 L 5 30 L 25 30 L 25 15" fill="none" stroke="#1a1a1a" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" /><text x="15" y="45" text-anchor="middle" font-size="9" font-weight="bold" fill="#22c55e" class="station-label">ä½å®¿</text></g>
                                <text x="50" y="380" font-size="18">ğŸŒ²</text><text x="280" y="100" font-size="18">ğŸŒ²</text>
                            </svg>
                        </div>
                    </div>
                `;
            } else {
                html = `
                    <div id="day3-detail" class="day-detail">
                        <h3 class="font-black text-xl mb-4 border-l-4 border-yellow-400 pl-3">ååŸèˆ‡è³¼ç‰©</h3>
                        <div class="relative pl-2">
                            <div class="timeline-line"></div>
                            <div class="relative flex items-start mb-6"><div class="bg-white border-2 border-black w-8 h-8 rounded-full flex items-center justify-center z-10 mr-3 flex-shrink-0"><span class="font-bold text-xs">08:00</span></div><div class="sketch-card p-3 flex-1"><h4 class="font-bold">Karasu</h4><p class="text-xs text-gray-500">å­¤ç¨çš„ç¾é£Ÿå®¶å’–å•¡å»³</p></div></div>
                            <div class="relative flex items-start mb-6"><div class="bg-yellow-100 border-2 border-black w-8 h-8 rounded-full flex items-center justify-center z-10 mr-3 flex-shrink-0"><i class="fas fa-landmark text-xs"></i></div><div class="sketch-card p-3 flex-1"><h4 class="font-bold">åå¤å±‹åŸ</h4><p class="text-xs text-gray-500">é‡‘é¯±èˆ‡æœ¬ä¸¸å¾¡æ®¿</p></div></div>
                            <div class="relative flex items-start mb-6"><div class="bg-green-100 border-2 border-black w-8 h-8 rounded-full flex items-center justify-center z-10 mr-3 flex-shrink-0"><i class="fas fa-tree text-xs"></i></div><div class="sketch-card p-3 flex-1"><h4 class="font-bold">å¾·å·åœ’</h4><p class="text-xs text-gray-500">æ—¥å¼åº­åœ’æ•£æ­¥</p></div></div>
                            <div class="relative flex items-start mb-6"><div class="bg-white border-2 border-black w-8 h-8 rounded-full flex items-center justify-center z-10 mr-3 flex-shrink-0"><i class="fas fa-utensils text-xs"></i></div><div class="sketch-card p-3 flex-1"><h4 class="font-bold">Yellow</h4><p class="text-xs text-gray-500">å‰‡æ­¦æ–°ç”º æ¿ƒåšæ­å§†è›‹åŒ…é£¯</p></div></div>
                            <div class="relative flex items-start mb-6"><div class="bg-purple-100 border-2 border-black w-8 h-8 rounded-full flex items-center justify-center z-10 mr-3 flex-shrink-0"><i class="fas fa-shopping-bag text-xs"></i></div><div class="sketch-card p-3 flex-1"><h4 class="font-bold">æ¦® (Sakae)</h4><p class="text-xs text-gray-500">LACHIC, ä¸­æ—¥å¤§æ¨“</p></div></div>
                            <div class="relative flex items-start mb-6"><div class="bg-orange-100 border-2 border-black w-8 h-8 rounded-full flex items-center justify-center z-10 mr-3 flex-shrink-0"><i class="fas fa-shrimp text-xs"></i></div><div class="sketch-card p-3 flex-1"><h4 class="font-bold">æµ·è€ã©ã¦é£Ÿå ‚</h4><p class="text-xs text-gray-500">35cm ç‰¹å¤§ç‚¸è¦</p></div></div>
                        </div>
                        <div class="map-container">
                            <h4 class="absolute top-2 left-3 font-bold text-[10px] bg-white px-2 py-1 border border-black rounded z-10">Day 3 Route</h4>
                            <svg viewBox="0 0 350 400" class="w-full h-full">
                                <path d="M 120 0 Q 110 200 130 400" fill="none" stroke="#e0f2fe" stroke-width="20" stroke-linecap="round" />
                                <line x1="0" y1="200" x2="350" y2="200" stroke="#e5e5e5" stroke-width="12" />
                                <line x1="230" y1="0" x2="230" y2="400" stroke="#e5e5e5" stroke-width="12" />
                                <path d="M 210 350 Q 200 250 120 100" fill="none" stroke="#4ade80" stroke-width="4" stroke-dasharray="6,8" stroke-linecap="round" class="path-line" marker-end="url(#arrow-green)" />
                                <path d="M 120 100 Q 200 80 280 120" fill="none" stroke="#4ade80" stroke-width="4" stroke-dasharray="6,8" stroke-linecap="round" class="path-line" marker-end="url(#arrow-green)" /> 
                                <path d="M 280 120 Q 280 180 230 220" fill="none" stroke="#4ade80" stroke-width="4" stroke-dasharray="6,8" stroke-linecap="round" class="path-line" marker-end="url(#arrow-green)" /> 
                                <path d="M 230 220 Q 240 300 210 350" fill="none" stroke="#4ade80" stroke-width="4" stroke-dasharray="6,8" stroke-linecap="round" class="path-line" marker-end="url(#arrow-green)" /> 
                                <text x="120" y="90" font-size="24" filter="url(#dropShadow)">ğŸ‹</text><text x="110" y="80" font-size="10" font-weight="bold" class="station-label">åå¤å±‹åŸ</text>
                                <text x="280" y="110" text-anchor="middle" font-size="10" font-weight="bold" class="station-label">å¾·å·åœ’</text>
                                <text x="210" y="200" font-size="28" filter="url(#dropShadow)">ğŸš‰</text><text x="230" y="225" text-anchor="middle" font-size="10" font-weight="bold" class="station-label">æ¦®</text>
                                <circle cx="120" cy="100" r="8" fill="#4ade80" stroke="white" stroke-width="2"/> <text x="120" y="104" text-anchor="middle" font-size="10" font-weight="bold" fill="white">1</text>
                                <circle cx="280" cy="120" r="8" fill="#4ade80" stroke="white" stroke-width="2"/> <text x="280" y="124" text-anchor="middle" font-size="10" font-weight="bold" fill="white">2</text>
                                <circle cx="230" cy="220" r="8" fill="#4ade80" stroke="white" stroke-width="2" transform="translate(15,-10)"/> <text x="245" y="214" text-anchor="middle" font-size="10" font-weight="bold" fill="white">3</text>
                                <text x="160" y="330" font-size="28" filter="url(#dropShadow)">ğŸš‰</text><text x="180" y="355" text-anchor="middle" font-size="10" font-weight="bold" class="station-label">ä¸Šå‰æ´¥</text>
                                <path d="M 190 340 Q 205 345 210 355" fill="none" stroke="black" stroke-width="1.5" stroke-dasharray="3,2" /><g transform="translate(210, 350)"><path d="M 0 15 L 15 0 L 30 15" fill="none" stroke="#1a1a1a" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" /><path d="M 5 15 L 5 30 L 25 30 L 25 15" fill="none" stroke="#1a1a1a" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" /><text x="15" y="45" text-anchor="middle" font-size="9" font-weight="bold" fill="#22c55e" class="station-label">ä½å®¿</text></g>
                            </svg>
                        </div>
                    </div>
                `;
            }
            contentDiv.innerHTML = html;
        }

        // ================= WALLET: CALCULATOR & EXPENSES =================
        const calcInput = document.getElementById('calc-input');
        const calcResult = document.getElementById('calc-result');
        const rateDisplay = document.getElementById('exchange-rate-display');

        async function fetchRate() {
            try {
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
                const data = await res.json();
                if(data.rates.TWD) {
                    exchangeRate = data.rates.TWD;
                    rateDisplay.textContent = exchangeRate.toFixed(3);
                    renderExpenses(); // Re-render to update TWD totals
                }
            } catch(e) { console.log('Rate fetch failed'); }
        }
        fetchRate();

        calcInput.addEventListener('input', (e) => {
            try {
                const val = e.target.value.replace(/[^0-9+\-*/.]/g, ''); 
                if(!val) { calcResult.textContent = '0'; return; }
                const resultJpy = Function('"use strict";return (' + val + ')')();
                const resultTwd = Math.round(resultJpy * exchangeRate);
                calcResult.textContent = isNaN(resultTwd) ? '...' : resultTwd.toLocaleString();
            } catch(e) {}
        });

        // Initialize Data
        let expensesData = JSON.parse(localStorage.getItem('nagoya_expenses_v2')) || {
            food: [], shopping: [], transport: [], accommodation: [], other: []
        };

        function renderExpenses() {
            const container = document.getElementById('expenses-container');
            container.innerHTML = '';
            let totalJPY = 0;
            let totalTWD = 0;
            let categoryTotals = {};

            // 1. Render Categories Group
            expenseCategories.forEach(cat => {
                // Calculate category total first
                let catTotalJPY = 0;
                if (expensesData[cat.id]) {
                    expensesData[cat.id].forEach(item => {
                        let amount = parseFloat(item.amount) || 0;
                        if(item.currency === 'TWD') {
                            catTotalJPY += (amount / exchangeRate); // Convert to JPY for chart
                        } else {
                            catTotalJPY += amount;
                        }
                    });
                }
                categoryTotals[cat.id] = catTotalJPY;

                const section = document.createElement('div');
                section.className = `sketch-card p-4 ${cat.color}`;
                
                let html = `
                    <div class="flex items-center gap-2 mb-3 border-b-2 border-black pb-2">
                        <i class="fas ${cat.icon} text-xl"></i>
                        <h3 class="font-bold text-lg">${cat.name}</h3>
                    </div>
                    <div class="space-y-2 mb-3" id="list-${cat.id}">
                `;

                if (expensesData[cat.id] && expensesData[cat.id].length > 0) {
                    expensesData[cat.id].forEach((item, index) => {
                        let displayPrice = "";
                        let amount = parseFloat(item.amount) || 0;
                        
                        if (item.currency === 'TWD') {
                            displayPrice = `NT$ ${amount.toLocaleString()}`;
                            totalTWD += amount;
                            totalJPY += (amount / exchangeRate);
                        } else {
                            displayPrice = `Â¥ ${amount.toLocaleString()}`;
                            totalJPY += amount;
                            totalTWD += (amount * exchangeRate);
                        }

                        html += `
                            <div class="expense-row">
                                <div class="flex items-center gap-2">
                                    ${item.photo ? `<img src="${item.photo}" class="w-8 h-8 object-cover rounded border border-black" onclick="alert('Photo View')">` : ''}
                                    <span class="font-bold text-gray-700 text-sm">${item.desc}</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="font-black mr-2 text-sm">${displayPrice}</span>
                                    <i class="fas fa-trash-alt delete-btn text-xs" onclick="deleteExpense('${cat.id}', ${index})"></i>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html += `<div class="text-xs text-gray-400 italic">ç„¡ç´€éŒ„</div>`;
                }
                html += `</div>`; // End List
                section.innerHTML = html;
                container.appendChild(section);
            });

            // 2. Render Pie Chart
            if (totalJPY > 0) {
                let currentAngle = 0;
                let gradientString = '';
                let legendHtml = '';

                expenseCategories.forEach((cat) => {
                    const catTotal = categoryTotals[cat.id] || 0;
                    if (catTotal > 0) {
                        const percent = (catTotal / totalJPY) * 100;
                        const endAngle = currentAngle + percent;
                        gradientString += `${cat.chartColor} ${currentAngle}% ${endAngle}%, `;
                        currentAngle = endAngle;
                        legendHtml += `
                            <div class="flex items-center gap-1">
                                <div class="w-3 h-3 rounded-full" style="background-color: ${cat.chartColor}"></div>
                                <span>${cat.name} (${Math.round(percent)}%)</span>
                            </div>
                        `;
                    }
                });
                gradientString = gradientString.slice(0, -2); // Remove trailing comma

                const chartSection = document.createElement('div');
                chartSection.innerHTML = `
                    <div class="sketch-card p-4 mt-6 bg-white mb-24 relative overflow-hidden">
                        <h3 class="font-bold text-lg mb-4 text-center border-b-2 border-dashed border-gray-300 pb-2">
                            <i class="fas fa-chart-pie mr-2"></i>æ”¯å‡ºåˆ†ä½ˆ (JPY)
                        </h3>
                        <div class="flex items-center justify-center py-2">
                            <div class="w-40 h-40 rounded-full border-2 border-black shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]" 
                                 style="background: conic-gradient(${gradientString})">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mt-4 text-xs justify-items-center">
                            ${legendHtml}
                        </div>
                    </div>
                `;
                container.appendChild(chartSection);
            }

            // Update Totals
            document.getElementById('total-jpy').textContent = Math.round(totalJPY).toLocaleString();
            document.getElementById('total-twd').textContent = Math.round(totalTWD).toLocaleString();
        }

        function handlePhotoUpload(input) {
            const label = document.getElementById('photo-label');
            if(input.files && input.files[0]) {
                label.textContent = "ç…§ç‰‡å·²é¸";
                label.classList.add('text-green-600', 'font-bold');
                
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxWidth = 300;
                        const scale = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        document.getElementById('expense-photo-base64').value = canvas.toDataURL('image/jpeg', 0.7);
                    }
                }
                reader.readAsDataURL(file);
            }
        }

        function addExpense() {
            const desc = document.getElementById('expense-item').value.trim();
            const amount = document.getElementById('expense-amount').value;
            const category = document.getElementById('expense-category').value;
            const currency = document.getElementById('expense-currency').value;
            const photo = document.getElementById('expense-photo-base64').value;

            if(!desc || !amount) { alert('è«‹è¼¸å…¥åç¨±èˆ‡é‡‘é¡'); return; }

            if (!expensesData[category]) expensesData[category] = [];
            
            expensesData[category].push({
                desc,
                amount,
                currency,
                photo,
                date: new Date().toISOString()
            });

            localStorage.setItem('nagoya_expenses_v2', JSON.stringify(expensesData));

            // Reset Form
            document.getElementById('expense-item').value = '';
            document.getElementById('expense-amount').value = '';
            document.getElementById('expense-photo').value = '';
            document.getElementById('expense-photo-base64').value = '';
            document.getElementById('photo-label').textContent = "ä¸Šå‚³ç…§ç‰‡ (é¸å¡«)";
            document.getElementById('photo-label').classList.remove('text-green-600', 'font-bold');

            renderExpenses();
        }

        function deleteExpense(catId, index) {
            if (confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†ç´€éŒ„ï¼Ÿ')) {
                expensesData[catId].splice(index, 1);
                localStorage.setItem('nagoya_expenses_v2', JSON.stringify(expensesData));
                renderExpenses();
            }
        }

        // ================= LISTS: CHECKLIST & MEMO =================
        function renderChecklist() {
            let list = JSON.parse(localStorage.getItem('nagoya_checklist'));
            if(!list) {
                list = defaultChecklist;
                localStorage.setItem('nagoya_checklist', JSON.stringify(list));
            }
            const container = document.getElementById('checklist-container');
            container.innerHTML = '';
            
            list.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2 p-2 border-b border-dashed border-gray-200';
                div.innerHTML = `
                    <input type="checkbox" id="check-${index}" ${item.checked ? 'checked' : ''} class="w-5 h-5 accent-black">
                    <label for="check-${index}" class="flex-1 ${item.checked ? 'line-through text-gray-400' : ''}">${item.text}</label>
                    <i class="fas fa-times text-gray-300 cursor-pointer" onclick="removeCheckItem(${index})"></i>
                `;
                div.querySelector('input').addEventListener('change', (e) => {
                    list[index].checked = e.target.checked;
                    localStorage.setItem('nagoya_checklist', JSON.stringify(list));
                    renderChecklist();
                });
                container.appendChild(div);
            });
        }

        function addCheckItem() {
            const input = document.getElementById('new-check-item');
            if(input.value) {
                let list = JSON.parse(localStorage.getItem('nagoya_checklist')) || [];
                list.push({ text: input.value, checked: false });
                localStorage.setItem('nagoya_checklist', JSON.stringify(list));
                input.value = '';
                renderChecklist();
            }
        }

        function removeCheckItem(index) {
            let list = JSON.parse(localStorage.getItem('nagoya_checklist'));
            list.splice(index, 1);
            localStorage.setItem('nagoya_checklist', JSON.stringify(list));
            renderChecklist();
        }

        const memoArea = document.getElementById('memo-area');
        const memoLinks = document.getElementById('memo-links');
        memoArea.value = localStorage.getItem('nagoya_memo') || '';
        
        memoArea.addEventListener('input', (e) => {
            const text = e.target.value;
            localStorage.setItem('nagoya_memo', text);
            parseMemoLinks(text);
        });

        function parseMemoLinks(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const matches = text.match(urlRegex);
            memoLinks.innerHTML = '';
            if(matches) {
                matches.forEach(url => {
                    const a = document.createElement('a');
                    a.href = url;
                    a.target = '_blank';
                    a.className = 'text-[10px] bg-blue-100 text-blue-600 px-2 py-1 rounded truncate max-w-[100px] inline-block border border-blue-200';
                    a.textContent = 'ğŸ”— Link';
                    memoLinks.appendChild(a);
                });
            }
        }

        // ================= INFO: WEATHER =================
        async function fetchWeather() {
            try {
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=35.18&longitude=136.90&current_weather=true');
                const data = await res.json();
                document.getElementById('temp-display').textContent = `${data.current_weather.temperature}Â°C`;
                document.getElementById('weather-desc').textContent = "å³æ™‚æ°£æº«";
            } catch(e) {
                document.getElementById('weather-desc').textContent = "ç„¡æ³•å–å¾—";
            }
        }

        // ================= INIT =================
        window.onload = function() {
            switchDay('day1'); // Load Day 1 content
            renderExpenses();
            renderChecklist();
            parseMemoLinks(memoArea.value);
            fetchWeather();
        };

    </script>
</body>
</html>