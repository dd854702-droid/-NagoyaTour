<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>åå¤å±‹ç­†è¨˜ 2026</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#fcfcfc">
    <meta name="apple-mobile-web-app-title" content="åå¤å±‹2026">
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoi5ZCN5Y+p5bGLMjAyNiIsInNob3J0X25hbWUiOiLlkI3lj6kyMDI2Iiwic3RhcnRfdXJsIjoiLi8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZmNmY2ZjIiwidGhlbWVfY29sb3IiOiIjZmNmY2ZjIiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vY2RuLWljb25zLXBuZy5mbGF0aWNvbi5jb20vNTEyLzcyMTEvNzIxMTc4My5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dfQ==">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/7211/7211783.png">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- QRCode Lib -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* ================== é¢¨æ ¼å®šç¾© (CSS Variables for Theming) ================== */
        :root {
            --paper-bg: #fcfcfc;
            --ink-color: #1a1a1a;
            --card-bg: #ffffff;
            --grid-line: #e5e5e5;
            --accent-blue: #eff6ff;
            --accent-yellow: #fefce8;
            --shadow-color: rgba(0,0,0,0.1);
            --shadow-offset: 3px;
        }

        [data-theme="dark"] {
            --paper-bg: #18181b;
            --ink-color: #e4e4e7;
            --card-bg: #27272a;
            --grid-line: #3f3f46;
            --accent-blue: #1e3a8a;
            --accent-yellow: #713f12;
            --shadow-color: #000;
        }

        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: var(--paper-bg);
            background-image: 
                linear-gradient(var(--grid-line) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--ink-color);
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            transition: background-color 0.3s, color 0.3s;
        }

        .app-shell {
            max-width: 480px;
            margin: 0 auto;
            background: var(--paper-bg);
            min-height: 100vh;
            border-left: 2px solid var(--ink-color);
            border-right: 2px solid var(--ink-color);
            position: relative;
            padding-bottom: 90px;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            transition: background 0.3s;
        }

        .sketch-card {
            background: var(--card-bg);
            border: 2px solid var(--ink-color);
            border-radius: 12px;
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0px 0px var(--ink-color);
            transition: transform 0.1s, box-shadow 0.1s, background 0.3s;
        }
        .sketch-card:active {
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0px 0px var(--ink-color);
        }

        .sketch-box {
            background: var(--card-bg);
            border: 2px solid var(--ink-color);
            border-radius: 12px;
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0px 0px var(--shadow-color);
            transition: background 0.3s;
        }

        .sketch-input {
            border: 2px solid var(--ink-color);
            border-radius: 8px;
            outline: none;
            background: var(--card-bg);
            color: var(--ink-color);
            box-shadow: inset 2px 2px 4px rgba(0,0,0,0.05);
            transition: background 0.2s;
        }
        .sketch-input:focus { background-color: var(--accent-yellow); }

        /* Dark Mode Overrides */
        [data-theme="dark"] .bg-white { background-color: var(--card-bg); }
        [data-theme="dark"] .bg-gray-100 { background-color: #3f3f46; }
        [data-theme="dark"] .bg-blue-50 { background-color: #172554; color: #dbeafe; }
        [data-theme="dark"] .bg-yellow-50 { background-color: #422006; color: #fef3c7; }
        [data-theme="dark"] .bg-yellow-100 { background-color: #713f12; color: #fef3c7; }
        [data-theme="dark"] .bg-red-50 { background-color: #450a0a; color: #ffe4e6; }
        [data-theme="dark"] .bg-red-100 { background-color: #7f1d1d; color: #fecaca; }
        [data-theme="dark"] .bg-green-100 { background-color: #064e3b; color: #d1fae5; }
        [data-theme="dark"] .bg-pink-100 { background-color: #831843; color: #fce7f3; }
        [data-theme="dark"] .bg-amber-100 { background-color: #78350f; color: #fef3c7; }
        [data-theme="dark"] .bg-amber-50 { background-color: #451a03; color: #fef3c7; }
        [data-theme="dark"] .bg-purple-100 { background-color: #4c1d95; color: #e9d5ff; }
        [data-theme="dark"] .bg-orange-100 { background-color: #7c2d12; color: #ffedd5; }
        [data-theme="dark"] .bg-orange-50 { background-color: #431407; color: #ffedd5; }
        [data-theme="dark"] .bg-blue-100 { background-color: #1e3a8a; color: #bfdbfe; }
        [data-theme="dark"] .bg-gray-700 { background-color: #3f3f46; }
        [data-theme="dark"] .text-gray-500, [data-theme="dark"] .text-gray-600, [data-theme="dark"] .text-gray-700, [data-theme="dark"] .text-gray-800 { color: #a1a1aa; }
        [data-theme="dark"] .text-gray-400 { color: #71717a; }
        [data-theme="dark"] .text-blue-800, [data-theme="dark"] .text-blue-600 { color: #bfdbfe; }
        [data-theme="dark"] .text-red-600, [data-theme="dark"] .text-red-500 { color: #fca5a5; }
        [data-theme="dark"] .text-amber-800 { color: #fcd34d; }
        [data-theme="dark"] .text-amber-600 { color: #fbbf24; }
        [data-theme="dark"] .border-gray-300, [data-theme="dark"] .border-gray-200, [data-theme="dark"] .border-orange-200, [data-theme="dark"] .border-yellow-200, [data-theme="dark"] .border-red-200 { border-color: #52525b; }
        [data-theme="dark"] .bg-gray-800 { background-color: #18181b; border-color: #52525b; }

        /* Navigation */
        .bottom-nav {
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 100%; max-width: 476px; background: var(--card-bg);
            border-top: 2px solid var(--ink-color);
            display: flex; justify-content: space-around; padding: 10px 0 20px;
            z-index: 100; transition: background 0.3s;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #9ca3af; font-weight: 700; font-size: 0.7rem; transition: all 0.2s; position: relative;
        }
        .nav-item i { font-size: 1.25rem; margin-bottom: 2px; }
        .nav-item.active { color: var(--ink-color); transform: translateY(-2px); }

        /* Page */
        .page-content { display: none; animation: fadeIn 0.3s ease-out; padding: 1.5rem; padding-bottom: 6rem; }
        .page-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Timeline */
        .timeline-line {
            position: absolute; left: 24px; top: 0; bottom: 0; width: 3px;
            background: repeating-linear-gradient(to bottom, var(--ink-color), var(--ink-color) 6px, transparent 6px, transparent 12px);
            z-index: 0;
        }
        .timeline-travel {
            margin-left: 20px; padding: 4px 8px; font-size: 0.65rem; color: #6b7280; background-color: var(--paper-bg); border: 1px dashed #d1d5db; border-radius: 12px; display: inline-block; position: relative; z-index: 1;
        }
        [data-theme="dark"] .timeline-travel { color: #a1a1aa; border-color: #52525b; }

        /* Expenses */
        .expense-row {
            border-bottom: 1px dashed #ccc; padding: 8px 0; display: flex; justify-content: space-between; align-items: center;
        }
        .expense-row:last-child { border-bottom: none; }

        /* Stickman */
        .stickman-arm { transform-origin: 25px 20px; animation: waveArm 0.6s ease-in-out infinite alternate; }
        @keyframes waveArm { from { transform: rotate(-10deg); } to { transform: rotate(25deg); } }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 200;
            display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px);
        }
        .modal-content {
            background: var(--card-bg); width: 90%; max-width: 400px;
            border: 2px solid var(--ink-color); border-radius: 15px;
            box-shadow: 4px 4px 0 var(--ink-color); padding: 20px; position: relative; color: var(--ink-color);
            animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>

    <!-- Shared SVG Defs -->
    <svg width="0" height="0" style="position:absolute">
        <defs>
            <filter id="dropShadow" x="-20%" y="-20%" width="140%" height="140%">
                <feGaussianBlur in="SourceAlpha" stdDeviation="1"/>
                <feOffset dx="1" dy="1" result="offsetblur"/>
                <feComponentTransfer><feFuncA type="linear" slope="0.3"/></feComponentTransfer>
                <feMerge><feMergeNode/><feMergeNode in="SourceGraphic"/></feMerge>
            </filter>
        </defs>
    </svg>

    <div class="app-shell">
        
        <!-- HEADER -->
        <div class="sticky top-0 bg-opacity-95 border-b-2 border-dashed border-gray-300 z-40 p-4 flex justify-between items-center backdrop-blur-sm" style="background-color: var(--card-bg);">
            <div>
                <h1 class="text-2xl font-black tracking-tight flex items-center gap-2">
                    <span>åå¤å±‹</span>
                    <span class="text-xs bg-black text-white px-2 py-1 rounded rotate-3 inline-block">2026</span>
                </h1>
                <p id="smart-status" class="text-[10px] font-bold text-blue-500 mt-0.5 animate-pulse">æº–å‚™å‡ºç™¼ï¼</p>
            </div>
            <div class="flex gap-3">
                <div id="page-title-icon" class="w-10 h-10 border-2 border-black rounded-full flex items-center justify-center bg-yellow-400 text-black shadow-[2px_2px_0_0_#000]">
                    <i class="fas fa-plane"></i>
                </div>
                <button onclick="toggleTheme()" class="w-10 h-10 border-2 border-black rounded-full flex items-center justify-center bg-gray-800 text-yellow-400 shadow-[2px_2px_0_0_#000]">
                    <i id="theme-icon" class="fas fa-moon"></i>
                </button>
            </div>
        </div>

        <!-- ================= PAGE: PLAN ================= -->
        <div id="page-plan" class="page-content active">
            
            <!-- Flight Info -->
            <div class="sketch-box p-3 bg-blue-50 mb-6 relative overflow-hidden">
                <div class="flex justify-between items-center relative z-10">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="bg-blue-600 text-white text-[10px] px-1 rounded">å»ç¨‹</span>
                            <span class="text-xs font-bold">IT 778 (3/02)</span>
                            <span class="text-[10px] font-mono ml-1">16:45-20:25</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="bg-orange-500 text-white text-[10px] px-1 rounded">å›ç¨‹</span>
                            <span class="text-xs font-bold">IT 779 (3/06)</span>
                            <span class="text-[10px] font-mono ml-1">13:15-15:25</span>
                        </div>
                    </div>
                    <div class="text-2xl opacity-20"><i class="fas fa-plane-departure"></i></div>
                </div>
                <!-- Countdown -->
                <div class="mt-3 pt-2 border-t border-blue-200 border-dashed">
                    <div class="text-[10px] text-blue-500 font-bold mb-1">è·é›¢å‡ºç™¼é‚„æœ‰ï¼š</div>
                    <div id="countdown-timer" class="text-lg font-black text-blue-800 font-mono tracking-tighter">Loading...</div>
                </div>
            </div>

            <!-- Transit Links -->
            <div class="flex gap-3 mb-6">
                <a href="https://transit.yahoo.co.jp/" target="_blank" class="flex-1 sketch-card p-2 flex items-center justify-center gap-2 hover:opacity-80">
                    <i class="fas fa-train text-green-600"></i>
                    <span class="text-xs font-bold">Yahoo! ä¹˜æ›</span>
                </a>
                <a href="https://www.google.com/maps" target="_blank" class="flex-1 sketch-card p-2 flex items-center justify-center gap-2 hover:opacity-80">
                    <i class="fas fa-map-marked-alt text-blue-600"></i>
                    <span class="text-xs font-bold">Google Maps</span>
                </a>
            </div>

            <!-- Accommodation -->
            <div class="sketch-card p-3 mb-6 flex items-center gap-3">
                <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center border border-black text-black">
                    <i class="fas fa-bed"></i>
                </div>
                <div class="flex-1">
                    <h3 class="font-bold text-sm">Trip & Sleep Hostel</h3>
                    <p class="text-[10px] text-gray-500">å¤§é ˆ/ä¸Šå‰æ´¥å€åŸŸ</p>
                </div>
                <a href="https://www.google.com/maps/search/?api=1&query=Trip+and+Sleep+Hostel+Nagoya" target="_blank" class="text-xs border border-black px-2 py-1 rounded hover:opacity-80">
                    <i class="fas fa-map-marker-alt text-red-500"></i> Map
                </a>
            </div>

            <!-- Day Tabs -->
            <div class="flex gap-2 overflow-x-auto hide-scrollbar mb-4">
                <button id="tab-day1" onclick="switchDay('day1')" class="day-tab active bg-white border-2 border-black px-4 py-2 rounded-lg font-bold text-sm whitespace-nowrap shadow-[2px_2px_0_0_#000] flex flex-col items-center justify-center leading-tight min-w-[100px] text-black">
                    <span class="text-base">Day 1</span>
                    <span class="text-xs font-normal mt-0.5">03/03(äºŒ)</span>
                </button>
                <button id="tab-day2" onclick="switchDay('day2')" class="day-tab bg-gray-100 border-2 border-transparent px-4 py-2 rounded-lg font-bold text-sm whitespace-nowrap text-gray-500 flex flex-col items-center justify-center leading-tight min-w-[100px]">
                    <span class="text-base">Day 2</span>
                    <span class="text-xs font-normal mt-0.5">03/04(ä¸‰)</span>
                </button>
                <button id="tab-day3" onclick="switchDay('day3')" class="day-tab bg-gray-100 border-2 border-transparent px-4 py-2 rounded-lg font-bold text-sm whitespace-nowrap text-gray-500 flex flex-col items-center justify-center leading-tight min-w-[100px]">
                    <span class="text-base">Day 3</span>
                    <span class="text-xs font-normal mt-0.5">03/05(å››)</span>
                </button>
            </div>

            <!-- Day Content Container -->
            <div id="day-content">
                <div class="text-center py-10 text-gray-400">
                    <i class="fas fa-circle-notch fa-spin text-2xl mb-2"></i>
                    <p class="text-xs">æ­£åœ¨è¼‰å…¥è¡Œç¨‹...</p>
                </div>
            </div>
        </div>

        <!-- ================= PAGE: GUIDE ================= -->
        <div id="page-guide" class="page-content">
            <h2 class="text-2xl font-black mb-4">æ·±åº¦å°è¦½ Guide</h2>
            
            <!-- Navigation Tags -->
            <div class="flex gap-2 overflow-x-auto pb-2 mb-4 hide-scrollbar">
                <span class="bg-black text-white text-xs px-3 py-1 rounded-full whitespace-nowrap font-bold shadow-sm">å…¨éƒ¨</span>
                <span class="bg-white border-2 border-black text-xs px-3 py-1 rounded-full whitespace-nowrap text-black font-bold">ğŸ¯ æ™¯é»</span>
                <span class="bg-white border-2 border-black text-xs px-3 py-1 rounded-full whitespace-nowrap text-black font-bold">ğŸ± ç¾é£Ÿ</span>
                <span class="bg-white border-2 border-black text-xs px-3 py-1 rounded-full whitespace-nowrap text-black font-bold">ğŸ›ï¸ è³¼ç‰©</span>
            </div>

            <div class="space-y-6">
                
                <!-- Sightseeing Section -->
                <h3 class="font-bold text-lg border-b-2 border-dashed border-gray-300 pb-1 mb-3 mt-2">ğŸ¯ å¿…è¨ªæ™¯é»</h3>

                <!-- Inuyama Castle -->
                <article class="sketch-card p-0 overflow-hidden group border-2 border-black">
                    <div class="h-40 bg-pink-100 relative flex items-center justify-center overflow-hidden">
                        <div class="text-8xl transition-transform group-hover:scale-110 duration-500 transform">ğŸ¯</div>
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-3 pt-10">
                            <h3 class="text-white font-black text-xl drop-shadow-md">çŠ¬å±±åŸ (Inuyama)</h3>
                        </div>
                        <div class="absolute top-2 right-2 bg-white/90 px-2 py-1 rounded text-[10px] font-bold border border-black text-black">åœ‹å¯¶äº”åŸ</div>
                    </div>
                    <div class="p-4 bg-white">
                        <p class="text-xs text-gray-500 mb-2 flex items-center gap-1"><i class="fas fa-map-marker-alt text-red-500"></i>æ„›çŸ¥ç¸£çŠ¬å±±å¸‚</p>
                        <p class="text-sm text-gray-800 leading-relaxed mb-3">
                            æ—¥æœ¬ç¾å­˜æœ€å¤è€çš„æœ¨é€ å¤©å®ˆé–£ï¼Œä½åœ¨æœ¨æ›¾å·ç•”çš„å°å±±ä¸˜ä¸Šã€‚çˆ¬ä¸Šé™¡å³­çš„æ¨“æ¢¯å¾Œï¼Œçµ•æ™¯ä¸€è¦½ç„¡éºã€‚
                        </p>
                        <div class="bg-gray-100 p-2 rounded text-xs text-gray-600 mb-3 border-l-4 border-pink-400">
                            <strong>ğŸ’¡ Tips:</strong> åŸä¸‹ç”ºæœ‰è‘—åçš„ã€Œæ„›å¿ƒç¹ªé¦¬ã€ä¸‰å…‰ç¨»è·ç¥ç¤¾ï¼Œæ±‚å§»ç·£è¶…éˆé©—ï¼é‚„æœ‰å¿…åƒã€Œé†¬æ²¹çƒ¤ç³°å­ã€ã€‚
                        </div>
                        <a href="https://www.google.com/maps/search/?api=1&query=Inuyama+Castle" target="_blank" class="block text-center bg-black text-white text-xs font-bold py-2 rounded hover:bg-gray-800 transition">
                            åœ¨ Google Maps æŸ¥çœ‹
                        </a>
                    </div>
                </article>

                <!-- Nagoya Castle -->
                <article class="sketch-card p-0 overflow-hidden group border-2 border-black">
                    <div class="h-40 bg-green-100 relative flex items-center justify-center overflow-hidden">
                        <div class="text-8xl transition-transform group-hover:scale-110 duration-500 transform">ğŸ‹</div>
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-3 pt-10">
                            <h3 class="text-white font-black text-xl drop-shadow-md">åå¤å±‹åŸ (Nagoya Castle)</h3>
                        </div>
                    </div>
                    <div class="p-4 bg-white">
                        <p class="text-xs text-gray-500 mb-2 flex items-center gap-1"><i class="fas fa-map-marker-alt text-red-500"></i>åå¤å±‹å¸‚ä¸­å€</p>
                        <p class="text-sm text-gray-800 leading-relaxed mb-3">
                            å¾·å·å®¶åº·ä¸‹ä»¤å»ºé€ ï¼Œå±‹é ‚ä¸Šçš„ã€Œé‡‘é¯±ã€æ˜¯åå¤å±‹çš„è±¡å¾µã€‚çµ•å°ä¸èƒ½éŒ¯éé‡‘ç¢§è¼ç…Œçš„ã€Œæœ¬ä¸¸å¾¡æ®¿ã€ã€‚
                        </p>
                        <div class="bg-gray-100 p-2 rounded text-xs text-gray-600 mb-3 border-l-4 border-green-500">
                            <strong>ğŸ’¡ Tips:</strong> é€±æœ«ç¶“å¸¸æœ‰ã€Œåå¤å±‹æ¬¾å¾…æ­¦å°‡éšŠã€çš„è¡¨æ¼”ï¼Œéå¸¸ç†±è¡€å¸¥æ°£ï¼
                        </div>
                        <a href="https://www.google.com/maps/search/?api=1&query=Nagoya+Castle" target="_blank" class="block text-center bg-black text-white text-xs font-bold py-2 rounded hover:bg-gray-800 transition">
                            åœ¨ Google Maps æŸ¥çœ‹
                        </a>
                    </div>
                </article>

                <!-- Oasis 21 -->
                <article class="sketch-card p-0 overflow-hidden group border-2 border-black">
                    <div class="h-40 bg-blue-100 relative flex items-center justify-center overflow-hidden">
                        <div class="text-8xl transition-transform group-hover:scale-110 duration-500 transform">ğŸ›¸</div>
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-3 pt-10">
                            <h3 class="text-white font-black text-xl drop-shadow-md">ç¶ æ´²21 (Oasis 21)</h3>
                        </div>
                    </div>
                    <div class="p-4 bg-white">
                        <p class="text-xs text-gray-500 mb-2 flex items-center gap-1"><i class="fas fa-map-marker-alt text-red-500"></i>æ¦® (Sakae)</p>
                        <p class="text-sm text-gray-800 leading-relaxed mb-3">
                            å¤–è§€åƒå®‡å®™é£›èˆ¹çš„ç«‹é«”å…¬åœ’ã€Œæ°´çš„å®‡å®™èˆ¹ã€ã€‚æ™šä¸Šé»ç‡ˆå¾Œéå¸¸æµªæ¼«ï¼Œå¯ä»¥èµ°åœ¨ç»ç’ƒå±‹é ‚ä¸Šæ•£æ­¥ã€‚
                        </p>
                        <a href="https://www.google.com/maps/search/?api=1&query=Oasis+21+Nagoya" target="_blank" class="block text-center bg-black text-white text-xs font-bold py-2 rounded hover:bg-gray-800 transition">
                            åœ¨ Google Maps æŸ¥çœ‹
                        </a>
                    </div>
                </article>

                <!-- Food Section -->
                <h3 class="font-bold text-lg border-b-2 border-dashed border-gray-300 pb-1 mb-3 mt-8">ğŸ± åå¤å±‹å¿…åƒç¾é£Ÿ</h3>

                <!-- Hitsumabushi -->
                <article class="sketch-card p-4 bg-orange-50 border-2 border-black relative">
                    <div class="absolute top-2 right-2 text-2xl opacity-10 rotate-12">ğŸ±</div>
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center border-2 border-black text-2xl shadow-[2px_2px_0_0_rgba(0,0,0,1)]">ğŸ¥¢</div>
                        <h3 class="font-bold text-lg text-black">é°»é­šé£¯ä¸‰åƒ</h3>
                    </div>
                    <p class="text-sm text-gray-700 mb-3 font-medium">
                        åå¤å±‹æœ€å¥¢è¯çš„ç¾é£Ÿé«”é©—ã€‚å°‡åˆ‡ç¢çš„è’²ç‡’é°»é­šé‹ªåœ¨é£¯ä¸Šï¼Œç¨å‰µçš„ã€Œä¸‰ç¨®åƒæ³•ã€è®“äººå›å‘³ç„¡çª®ã€‚
                    </p>
                    <div class="bg-white p-3 rounded-lg border-2 border-black text-xs space-y-2 shadow-sm">
                        <div class="flex gap-2 items-start"><span class="bg-black text-white w-5 h-5 rounded-full flex-shrink-0 flex items-center justify-center font-bold text-[10px]">1</span><span class="text-gray-800"><strong>åŸå‘³ï¼š</strong>ç›´æ¥å“åšç‚­çƒ¤é¦™æ°£èˆ‡é†¬æ±ç¾å‘³ã€‚</span></div>
                        <div class="flex gap-2 items-start"><span class="bg-black text-white w-5 h-5 rounded-full flex-shrink-0 flex items-center justify-center font-bold text-[10px]">2</span><span class="text-gray-800"><strong>ä½æ–™ï¼š</strong>åŠ å…¥è”¥èŠ±ã€èŠ¥æœ«ã€æµ·è‹”ï¼Œå£æ„Ÿå±¤æ¬¡è±å¯Œã€‚</span></div>
                        <div class="flex gap-2 items-start"><span class="bg-black text-white w-5 h-5 rounded-full flex-shrink-0 flex items-center justify-center font-bold text-[10px]">3</span><span class="text-gray-800"><strong>èŒ¶æ³¡é£¯ï¼š</strong>æ·‹ä¸Šé«˜æ¹¯ï¼Œæ¸…çˆ½è§£è†©çš„å®Œç¾å¥é»ã€‚</span></div>
                    </div>
                    <div class="mt-3 flex gap-2 overflow-x-auto">
                        <a href="https://www.google.com/maps/search/?api=1&query=Atsuta+Houraiken" target="_blank" class="text-[10px] bg-white border border-black px-2 py-1 rounded hover:bg-gray-100 whitespace-nowrap text-black font-bold">ğŸ“ ç†±ç”°è“¬èŠè»’</a>
                        <a href="https://www.google.com/maps/search/?api=1&query=Hitsumabushi+Ino" target="_blank" class="text-[10px] bg-white border border-black px-2 py-1 rounded hover:bg-gray-100 whitespace-nowrap text-black font-bold">ğŸ“ å‚™é•·</a>
                    </div>
                </article>

                <!-- Morning Service -->
                <article class="sketch-card p-4 bg-yellow-50 border-2 border-black relative">
                    <div class="absolute top-2 right-2 text-2xl opacity-10 rotate-12">ğŸ</div>
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center border-2 border-black text-2xl shadow-[2px_2px_0_0_rgba(0,0,0,1)]">â˜•</div>
                        <h3 class="font-bold text-lg text-black">Morning Service</h3>
                    </div>
                    <p class="text-sm text-gray-700 mb-3 font-medium">
                        åå¤å±‹ç‰¹æœ‰çš„ã€Œè²·é£²æ–™é€æ—©é¤ã€æ–‡åŒ–ã€‚é€šå¸¸åœ¨æ—©ä¸Š 11:00 å‰ï¼Œåªè¦é»ä¸€æ¯å’–å•¡ï¼Œåº—å®¶å°±æœƒå…è²»é™„è´ˆåå¸å’Œæ°´ç…®è›‹ï¼ˆæˆ–ç´…è±†æ³¥ï¼‰ã€‚
                    </p>
                    <div class="bg-white p-3 rounded-lg border-2 border-black text-xs text-gray-800 shadow-sm">
                        <strong class="block mb-2 border-b border-gray-200 pb-1">ğŸ’¡ æ¨è–¦ååº—ï¼š</strong>
                        <ul class="list-disc pl-4 space-y-1">
                            <li><b>Komeda's Coffee</b>ï¼šå…¨æ—¥æœ¬é€£é–ï¼Œä½†ç™¼æºåœ°ä¸€å®šè¦æœè–ã€‚</li>
                            <li><b>Bucyo Coffee</b>ï¼šå°å€‰ç´…è±†åå¸è¶…æœ‰å (Day 2 è¡Œç¨‹)ã€‚</li>
                            <li><b>Konparu</b>ï¼šæ˜­å’Œå¾©å¤é¢¨ï¼Œç‚¸è¦ä¸‰æ˜æ²»æ˜¯ä¸€çµ•ã€‚</li>
                        </ul>
                    </div>
                </article>

                <!-- Solo Pizza -->
                <article class="sketch-card p-4 bg-red-50 border-2 border-black">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center border-2 border-black text-2xl shadow-[2px_2px_0_0_rgba(0,0,0,1)]">ğŸ•</div>
                        <h3 class="font-bold text-lg text-black">ä¸–ç•Œå† è»æŠ«è–©</h3>
                    </div>
                    <p class="text-sm text-gray-700 mb-3 font-medium">
                        ä½æ–¼å¤§é ˆçš„ <b>Solo Pizza Napoletana</b>ã€‚ä¸»å»šç‰§å³¶æ˜­æˆæ›¾åœ¨æ‹¿å¡é‡ŒæŠ«è–©ä¸–ç•Œå¤§è³½å¥ªå† ã€‚åƒ¹æ ¼è¦ªæ°‘ï¼Œæ˜¯æ’éšŠååº—ã€‚
                    </p>
                    <div class="flex items-center justify-between mt-2">
                        <span class="text-xs bg-white border border-black px-2 py-1 rounded font-bold text-black shadow-[1px_1px_0_0_#000]">Day 2 æ™šé¤</span>
                        <a href="https://www.google.com/maps/search/?api=1&query=Solo+Pizza+Napoletana+Osu" target="_blank" class="text-xs font-bold underline text-black">é–‹å•Ÿåœ°åœ– ></a>
                    </div>
                </article>

                <!-- Shopping Section -->
                <h3 class="font-bold text-lg border-b-2 border-dashed border-gray-300 pb-1 mb-3 mt-8">ğŸ›ï¸ é€›è¡—è–åœ°</h3>

                <article class="sketch-card p-4 border-2 border-black bg-purple-50">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h3 class="font-bold text-lg text-black">å¤§é ˆå•†åº—è¡— (Osu)</h3>
                            <p class="text-xs text-gray-500 mb-2 font-bold">å¥½é€›å¥½è²·çš„æ··æ²Œè¿·å®®</p>
                        </div>
                        <div class="text-4xl">ğŸ®</div>
                    </div>
                    <p class="text-sm text-gray-800 leading-relaxed mb-3">
                        çµåˆäº†ç§‹è‘‰åŸçš„é›»å™¨å‹•æ¼«ã€åŸå®¿çš„æ½®æµå¤è‘—ã€ä»¥åŠæ·ºè‰çš„å‚³çµ±å¯ºå»Ÿã€‚é€™è£¡æœ‰è¶…é1200å®¶åº—èˆ–ï¼Œæ˜¯æŒ–å¯¶å’Œé‚Šèµ°é‚Šåƒçš„å¤©å ‚ã€‚
                    </p>
                    <div class="flex flex-wrap gap-2 text-[10px]">
                        <span class="bg-white px-2 py-1 rounded border border-black text-black">#å¤è‘—</span>
                        <span class="bg-white px-2 py-1 rounded border border-black text-black">#å¥³åƒ•å’–å•¡</span>
                        <span class="bg-white px-2 py-1 rounded border border-black text-black">#ç‚¸é›</span>
                        <span class="bg-white px-2 py-1 rounded border border-black text-black">#Alice on Wednesday</span>
                    </div>
                </article>

            </div>
        </div>

        <!-- ================= PAGE: WALLET ================= -->
        <div id="page-wallet" class="page-content">
            <h2 class="text-2xl font-black mb-4">è¨˜å¸³ & åŒ¯ç‡ Wallet</h2>

            <!-- Budget Control -->
            <div class="sketch-box p-3 bg-gray-100 mb-4 border-dashed">
                <div class="flex justify-between items-center mb-2">
                    <div class="text-xs font-bold text-gray-500">ç¸½é ç®—è¨­å®š (TWD)</div>
                    <input type="number" id="budget-input" class="bg-transparent border-b border-gray-400 text-right w-24 font-mono text-sm focus:outline-none text-black" placeholder="è¨­å®šé‡‘é¡" onchange="updateBudget()">
                </div>
                <div class="h-2 bg-gray-300 rounded-full overflow-hidden">
                    <div id="budget-bar" class="h-full bg-green-500 w-0 transition-all duration-500"></div>
                </div>
                <div class="flex justify-between mt-1">
                    <span class="text-[10px] text-gray-400">å·²æ”¯å‡º: $<span id="budget-spent">0</span></span>
                    <span class="text-[10px] text-gray-400">å‰©é¤˜: $<span id="budget-left">0</span></span>
                </div>
            </div>

            <!-- Currency Converter -->
            <div class="sketch-card p-4 bg-gray-800 text-white mb-6">
                <h3 class="text-xs font-bold text-gray-400 mb-2 uppercase">Quick Converter (Jpy â†’ Twd)</h3>
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-xl font-bold">Â¥</span>
                    <input type="text" id="calc-input" placeholder="è¼¸å…¥ç®—å¼ (å¦‚ 500*3)" class="w-full bg-transparent border-b border-gray-600 text-2xl font-mono focus:outline-none focus:border-yellow-400 text-white">
                </div>
                <div class="flex justify-between items-end">
                    <div class="text-xs text-gray-400">Rate: <span id="rate-display">0.215</span></div>
                    <div class="text-right"><div class="text-3xl font-black text-yellow-400">NT$ <span id="calc-result">0</span></div></div>
                </div>
            </div>

            <!-- Expense Entry Form -->
            <div class="sketch-box p-4 bg-white mb-6">
                <div class="text-center text-sm font-bold text-gray-600 flex items-center justify-center gap-2 mb-4 bg-yellow-50 p-2 rounded border border-dashed border-yellow-300">
                    <span>ğŸ’¡ å¯ç”¨å°å¹£/æ—¥å¹£åƒ¹æ ¼è¼¸å…¥</span>
                    <svg width="24" height="24" viewBox="0 0 50 50" overflow="visible"><circle cx="25" cy="10" r="5" fill="none" stroke="#4b5563" stroke-width="2"/><line x1="25" y1="15" x2="25" y2="35" stroke="#4b5563" stroke-width="2"/><line x1="25" y1="35" x2="18" y2="45" stroke="#4b5563" stroke-width="2"/><line x1="25" y1="35" x2="32" y2="45" stroke="#4b5563" stroke-width="2"/><line x1="25" y1="20" x2="15" y2="25" stroke="#4b5563" stroke-width="2"/><g class="stickman-arm"><line x1="25" y1="20" x2="35" y2="10" stroke="#4b5563" stroke-width="2"/><rect x="32" y="2" width="14" height="8" fill="#86efac" stroke="#4b5563" stroke-width="1" transform="rotate(-15 32 10)"/><text x="39" y="9" font-size="6" font-weight="bold" fill="#065f46" text-anchor="middle" transform="rotate(-15 32 10)">Â¥</text></g></svg>
                </div>
                
                <div class="space-y-3">
                    <input type="text" id="expense-item" placeholder="å“é …åç¨± (å¦‚: æ™šé¤)" class="sketch-input w-full p-2">
                    <div class="flex gap-2 items-center">
                        <div class="relative w-12 h-12 flex-shrink-0">
                            <div class="absolute inset-0 border-2 border-black rounded-lg flex items-center justify-center bg-white pointer-events-none z-10 shadow-[2px_2px_0_0_#ccc]">
                                <i id="category-icon" class="fas fa-utensils text-lg text-black"></i>
                            </div>
                            <select id="expense-category" onchange="updateCategoryIcon(this)" class="w-full h-full opacity-0 absolute inset-0 z-20 cursor-pointer">
                                <option value="food">é£²é£Ÿ</option>
                                <option value="shopping">è³¼ç‰©</option>
                                <option value="transport">äº¤é€š</option>
                                <option value="accommodation">ä½å®¿</option>
                                <option value="other">å…¶ä»–</option>
                            </select>
                        </div>
                        <div class="relative w-12 h-12 flex-shrink-0">
                            <div class="absolute inset-0 border-2 border-black rounded-lg flex items-center justify-center bg-white pointer-events-none z-10 shadow-[2px_2px_0_0_#ccc]">
                                <span id="currency-symbol" class="font-black text-lg text-black">Â¥</span>
                            </div>
                            <select id="expense-currency" onchange="updateCurrencySymbol(this)" class="w-full h-full opacity-0 absolute inset-0 z-20 cursor-pointer">
                                <option value="JPY">JPY</option>
                                <option value="TWD">TWD</option>
                            </select>
                        </div>
                        <input type="number" id="expense-amount" placeholder="é‡‘é¡" class="sketch-input flex-1 min-w-0 h-12 p-2 font-mono text-lg">
                    </div>
                    <div class="flex gap-2">
                        <label class="flex-1 flex items-center justify-center gap-2 border-2 border-dashed border-gray-300 rounded-lg p-2 cursor-pointer hover:opacity-80 transition">
                            <i class="fas fa-camera text-gray-400"></i><span class="text-xs text-gray-500" id="photo-label">ç…§ç‰‡</span>
                            <input type="file" id="expense-photo" accept="image/*" class="hidden" onchange="handlePhotoUpload(this)">
                        </label>
                        <label class="flex-1 flex items-center justify-center gap-2 border-2 border-gray-300 rounded-lg p-2 cursor-pointer bg-gray-50 has-[:checked]:bg-green-50 has-[:checked]:border-green-500 transition">
                            <input type="checkbox" id="expense-shared" class="accent-green-500">
                            <span class="text-xs font-bold text-gray-600">å…¬è²» (Shared)</span>
                        </label>
                    </div>
                    <input type="hidden" id="expense-photo-base64">
                    <button onclick="addExpense()" class="w-full bg-black text-white font-bold py-2 rounded-lg hover:bg-gray-800 transition shadow-[2px_2px_0_0_#ccc]">è¨˜ä¸€ç­†</button>
                </div>
            </div>

            <div id="expenses-container" class="space-y-6 pb-20"></div>
            
            <div class="fixed bottom-[70px] left-0 right-0 bg-gray-900 text-white p-4 mx-4 rounded-xl shadow-2xl z-50 border-2 border-white max-w-[448px] md:mx-auto">
                <div class="flex justify-between items-center">
                    <div><div class="text-[10px] text-gray-400 uppercase tracking-widest">Total Expenses</div><div class="text-2xl font-black text-yellow-400">Â¥ <span id="total-jpy">0</span></div></div>
                    <div class="text-right"><div class="text-[10px] text-gray-400">Approx. TWD</div><div class="text-lg font-bold">NT$ <span id="total-twd">0</span></div></div>
                </div>
            </div>
        </div>

        <!-- ================= PAGE: LISTS ================= -->
        <div id="page-lists" class="page-content">
            <h2 class="text-2xl font-black mb-4">æ¸…å–® Lists</h2>
            <div class="sketch-card p-4 mb-6 bg-yellow-50">
                <h3 class="font-bold mb-3 border-b-2 border-black pb-1 text-black"><i class="fas fa-check-square mr-2"></i>è¡Œå‰æº–å‚™</h3>
                <div id="checklist-container" class="space-y-2"></div>
                <div class="mt-3 flex gap-2">
                    <input type="text" id="new-check-item" placeholder="æ–°å¢é …ç›®..." class="sketch-input flex-1 p-1 text-sm">
                    <button onclick="addCheckItem()" class="bg-black text-white w-8 rounded"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div class="sketch-card p-4 bg-white">
                <h3 class="font-bold mb-3 border-b-2 border-black pb-1"><i class="fas fa-sticky-note mr-2"></i>å€‹äººå‚™å¿˜éŒ„</h3>
                <textarea id="memo-area" class="w-full h-40 p-2 text-sm border border-gray-200 rounded resize-none focus:outline-none bg-white text-black" placeholder="è¼¸å…¥å‚™å¿˜..."></textarea>
                <div id="memo-links" class="mt-2 flex flex-wrap gap-2"></div>
            </div>
        </div>

        <!-- ================= PAGE: INFO ================= -->
        <div id="page-info" class="page-content">
            <h2 class="text-2xl font-black mb-4">å¯¦ç”¨è³‡è¨Š Info</h2>
            
            <div class="sketch-box p-3 mb-6 bg-blue-50 border-dashed text-center">
                <h3 class="font-bold text-sm mb-1 text-blue-900">ğŸ“± å¦‚ä½•å®‰è£åˆ°æ‰‹æ©Ÿæ¡Œé¢ (APP)</h3>
                <div class="text-xs text-gray-600 text-left px-2 leading-relaxed">
                    <p class="mb-1"><i class="fab fa-apple mr-1"></i> <strong>iPhone (Safari):</strong> é»æ“Šä¸‹æ–¹ã€Œåˆ†äº«ã€åœ–ç¤º <i class="fas fa-share-square"></i> â†’ æ»‘å‹•é¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€ã€‚</p>
                    <p><i class="fab fa-android mr-1"></i> <strong>Android (Chrome):</strong> é»æ“Šå³ä¸Šè§’é¸å–® <i class="fas fa-ellipsis-v"></i> â†’ é¸æ“‡ã€Œå®‰è£æ‡‰ç”¨ç¨‹å¼ã€æˆ–ã€ŒåŠ åˆ°ä¸»ç•«é¢ã€ã€‚</p>
                </div>
            </div>
            
            <!-- Weather -->
            <div class="sketch-card p-4 mb-6 bg-gradient-to-br from-blue-100 to-white relative overflow-hidden">
                <h3 class="font-bold mb-2 text-black">åå¤å±‹å¤©æ°£</h3>
                <div id="weather-widget" class="flex items-center justify-between">
                    <div><div class="text-3xl font-black text-black" id="temp-display">--Â°C</div><div class="text-sm text-gray-600" id="weather-desc">Loading...</div></div>
                    <div class="text-4xl opacity-50 text-black"><i class="fas fa-cloud-sun"></i></div>
                </div>
            </div>

            <!-- Data Management -->
            <div class="sketch-card p-4 mb-6 bg-gray-50">
                <h3 class="font-bold mb-3 text-sm text-gray-700"><i class="fas fa-database mr-2"></i>è³‡æ–™ç®¡ç†</h3>
                <div class="flex gap-2 mb-3">
                    <button onclick="resetItinerary()" class="w-full bg-red-100 border border-red-500 rounded p-2 text-xs font-bold hover:bg-red-200 text-red-800">âš ï¸ é‡ç½®å…¬å…±è¡Œç¨‹</button>
                </div>
                <div class="flex gap-2 mb-3">
                    <button onclick="downloadBackup()" class="flex-1 bg-white border border-black rounded p-2 text-xs font-bold hover:bg-gray-100 text-black">ğŸ“¥ ä¸‹è¼‰å‚™ä»½æª”</button>
                    <label class="flex-1 bg-black text-white border border-black rounded p-2 text-xs font-bold hover:bg-gray-800 text-center cursor-pointer">
                        ğŸ“¤ è®€å–å‚™ä»½æª”
                        <input type="file" id="backup-input" class="hidden" onchange="restoreBackup(this)">
                    </label>
                </div>
                <button onclick="exportCSV()" class="w-full bg-green-100 border border-black rounded p-2 text-xs font-bold hover:bg-green-200 text-green-800">ğŸ“Š åŒ¯å‡ºè¨˜å¸³ Excel (CSV)</button>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-6">
                <button onclick="showTranslation('è”¥', 'ãƒã‚®æŠœãã§ãŠé¡˜ã„ã—ã¾ã™', 'è«‹ä¸è¦åŠ è”¥')" class="sketch-card p-3 hover:opacity-80 text-center"><div class="text-2xl">ğŸ§…</div><div class="text-xs font-bold">ä¸è¦è”¥</div></button>
                <button onclick="showTranslation('å†°', 'æ°·ãªã—ã§ãŠé¡˜ã„ã—ã¾ã™', 'è«‹å»å†°')" class="sketch-card p-3 hover:opacity-80 text-center"><div class="text-2xl">ğŸ§Š</div><div class="text-xs font-bold">å»å†°</div></button>
                <button onclick="showTranslation('æ°´', 'ãŠæ°´ãã ã•ã„', 'è«‹çµ¦æˆ‘æ°´')" class="sketch-card p-3 hover:opacity-80 text-center"><div class="text-2xl">ğŸ’§</div><div class="text-xs font-bold">è«‹çµ¦æ°´</div></button>
                <button onclick="showTranslation('å»æ‰€', 'ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹ï¼Ÿ', 'å»æ‰€åœ¨å“ªè£¡')" class="sketch-card p-3 hover:opacity-80 text-center"><div class="text-2xl">ğŸš»</div><div class="text-xs font-bold">å»æ‰€</div></button>
            </div>

            <button onclick="toggleModal('modal-size')" class="w-full sketch-card p-3 mb-6 flex items-center justify-between hover:opacity-80">
                <span class="font-bold"><i class="fas fa-ruler-combined mr-2 text-purple-500"></i>å°ºç¢¼å°ç…§è¡¨</span>
                <i class="fas fa-chevron-right text-gray-400"></i>
            </button>
            
            <div class="sketch-card p-4 mb-6 bg-red-50 border-2 border-red-100">
                <h3 class="font-bold mb-3 text-red-600 border-b border-red-200 pb-1"><i class="fas fa-ambulance mr-2"></i>ç·Šæ€¥è¯çµ¡</h3>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <a href="tel:110" class="bg-white p-3 rounded-lg border border-red-100 shadow-sm flex flex-col items-center justify-center hover:bg-red-50 transition"><i class="fas fa-user-shield text-xl text-blue-800 mb-1"></i><span class="text-xs font-bold text-gray-600">è­¦å¯Ÿ (110)</span></a>
                    <a href="tel:119" class="bg-white p-3 rounded-lg border border-red-100 shadow-sm flex flex-col items-center justify-center hover:bg-red-50 transition"><i class="fas fa-ambulance text-xl text-red-500 mb-1"></i><span class="text-xs font-bold text-gray-600">æ•‘è­· (119)</span></a>
                </div>
            </div>
        </div>

        <!-- MODALS -->
        <div id="modal-size" class="modal-overlay" onclick="if(event.target===this) toggleModal('modal-size')">
            <div class="modal-content">
                <h3 class="font-bold text-lg mb-4 border-b-2 border-black pb-2">å°ºç¢¼å°ç…§è¡¨ (JP)</h3>
                <div class="space-y-4 text-sm">
                    <div><h4 class="font-bold bg-gray-100 p-1 mb-1 text-black">ğŸ‘Ÿ é‹ç¢¼ (å¥³)</h4><div class="grid grid-cols-3 gap-2 text-center"><div class="border p-1">JP</div><div class="border p-1">US</div><div class="border p-1">EU</div><div>23</div><div>6</div><div>36</div><div>23.5</div><div>6.5</div><div>37</div><div>24</div><div>7</div><div>38</div><div>24.5</div><div>7.5</div><div>39</div></div></div>
                    <div><h4 class="font-bold bg-gray-100 p-1 mb-1 text-black">ğŸ‘Ÿ é‹ç¢¼ (ç”·)</h4><div class="grid grid-cols-3 gap-2 text-center"><div class="border p-1">JP</div><div class="border p-1">US</div><div class="border p-1">EU</div><div>26</div><div>8</div><div>41</div><div>27</div><div>9</div><div>42.5</div><div>28</div><div>10</div><div>44</div></div></div>
                </div>
                <button onclick="toggleModal('modal-size')" class="mt-4 w-full bg-black text-white p-2 rounded font-bold">é—œé–‰</button>
            </div>
        </div>

        <div id="modal-trans" class="modal-overlay" onclick="if(event.target===this) toggleModal('modal-trans')">
            <div class="modal-content flex flex-col items-center justify-center text-center" style="min-height: 300px;">
                <div class="text-6xl mb-4" id="trans-icon">ğŸ—£ï¸</div>
                <h2 class="text-2xl font-black mb-2" id="trans-jp">ã“ã‚“ã«ã¡ã¯</h2>
                <p class="text-lg text-gray-500 mb-6" id="trans-zh">ä½ å¥½</p>
                <p class="text-xs text-gray-400">è«‹å‡ºç¤ºæ­¤ç•«é¢çµ¦åº—å“¡çœ‹</p>
                <button onclick="toggleModal('modal-trans')" class="mt-auto w-full bg-black text-white p-3 rounded font-bold">é—œé–‰</button>
            </div>
        </div>

        <!-- Add/Edit Item Modal -->
        <div id="modal-add-item" class="modal-overlay" onclick="if(event.target===this) toggleModal('modal-add-item')">
            <div class="modal-content">
                <h3 class="font-bold text-lg mb-4 border-b-2 border-black pb-2" id="modal-title">æ–°å¢è¡Œç¨‹</h3>
                <div class="space-y-3">
                    <div>
                        <label class="text-xs font-bold text-gray-500">é¡å‹</label>
                        <select id="new-item-type" class="w-full border-2 border-black rounded p-2 bg-white text-black">
                            <option value="spot">ğŸ“ æ™¯é»/æ´»å‹• (Spot)</option>
                            <option value="food">ğŸ´ é¤å»³/é£²é£Ÿ (Food)</option>
                            <option value="shop">ğŸ›ï¸ è³¼ç‰© (Shopping)</option>
                            <option value="transport">ğŸšƒ äº¤é€šç§»å‹• (Transport)</option>
                        </select>
                    </div>
                    <!-- Fields for Spots/Food/Shop -->
                    <div id="new-item-fields">
                        <div class="flex gap-2">
                            <div class="w-1/3">
                                <label class="text-xs font-bold text-gray-500">æ™‚é–“</label>
                                <input type="time" id="new-item-time" class="w-full border-2 border-gray-300 rounded p-2 text-black">
                            </div>
                            <div class="w-2/3">
                                <label class="text-xs font-bold text-gray-500">æ¨™é¡Œ</label>
                                <input type="text" id="new-item-title" placeholder="åœ°é»åç¨±" class="w-full border-2 border-gray-300 rounded p-2 text-black">
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500">æè¿° (å‰¯æ¨™é¡Œ)</label>
                            <input type="text" id="new-item-desc" placeholder="ç°¡çŸ­èªªæ˜" class="w-full border-2 border-gray-300 rounded p-2 text-black">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500">Google Maps æœå°‹é—œéµå­—</label>
                            <input type="text" id="new-item-query" placeholder="ç”¨æ–¼åœ°åœ–é€£çµ" class="w-full border-2 border-gray-300 rounded p-2 text-black">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500">å‚™è¨» (è—è‰²å­—é«”)</label>
                            <input type="text" id="new-item-note" placeholder="é¡å¤–ç­†è¨˜..." class="w-full border-2 border-gray-300 rounded p-2 text-black">
                        </div>
                    </div>
                    
                    <!-- Fields for Transport Only -->
                    <div id="new-item-transport-fields" class="hidden">
                        <label class="text-xs font-bold text-gray-500">ç§»å‹•èªªæ˜</label>
                        <input type="text" id="new-item-trans-desc" placeholder="ä¾‹ï¼šğŸšƒ ç§»å‹•ç´„ 30åˆ†" class="w-full border-2 border-gray-300 rounded p-2 text-black">
                    </div>

                    <button onclick="saveNewItem()" id="btn-save-item" class="w-full bg-black text-white font-bold py-2 rounded mt-2">å„²å­˜</button>
                </div>
            </div>
        </div>

        <!-- BOTTOM NAV -->
        <nav class="bottom-nav">
            <button onclick="switchPage('page-plan')" id="nav-plan" class="nav-item active"><i class="fas fa-map-marked-alt"></i><span class="mt-1">PLAN</span></button>
            <button onclick="switchPage('page-guide')" id="nav-guide" class="nav-item"><i class="fas fa-book-open"></i><span class="mt-1">GUIDE</span></button>
            <button onclick="switchPage('page-wallet')" id="nav-wallet" class="nav-item"><i class="fas fa-wallet"></i><span class="mt-1">WALLET</span></button>
            <button onclick="switchPage('page-lists')" id="nav-lists" class="nav-item"><i class="fas fa-list-check"></i><span class="mt-1">LISTS</span></button>
            <button onclick="switchPage('page-info')" id="nav-info" class="nav-item"><i class="fas fa-info-circle"></i><span class="mt-1">INFO</span></button>
        </nav>
    </div>

    <!-- UI Scripts -->
    <script>
        // ================= DATA & STATE =================
        let exchangeRate = 0.215;
        let currentDayId = 'day1';
        let itineraryData = {};
        let editingItemIndex = -1; // Track which item is being edited

        // Try to load from local storage immediately for fast render
        try {
            const cachedData = localStorage.getItem('nagoya_itinerary_data');
            if (cachedData) {
                itineraryData = JSON.parse(cachedData);
            } else {
                // Fallback to default data for immediate rendering (Optimistic UI)
                // Define default data here since it's used before definition if we are not careful, 
                // but actually we define it below. Let's keep it safe.
            }
        } catch (e) {
            console.error("Error loading cached itinerary:", e);
        }

        const expenseCategories = [
            { id: 'food', name: 'é£²é£Ÿ', icon: 'fa-utensils', color: 'bg-orange-50', chartColor: '#fdba74' },
            { id: 'shopping', name: 'è³¼ç‰©', icon: 'fa-shopping-bag', color: 'bg-pink-50', chartColor: '#f9a8d4' },
            { id: 'transport', name: 'äº¤é€š', icon: 'fa-train', color: 'bg-blue-50', chartColor: '#93c5fd' },
            { id: 'accommodation', name: 'ä½å®¿', icon: 'fa-bed', color: 'bg-purple-50', chartColor: '#d8b4fe' },
            { id: 'other', name: 'å…¶ä»–', icon: 'fa-ellipsis-h', color: 'bg-gray-100', chartColor: '#d1d5db' }
        ];
        
        const defaultChecklist = [
            { text: "è­·ç…§", checked: false }, { text: "ç¶²å¡ / Roaming", checked: false }, { text: "æ—¥å¹£ç¾é‡‘", checked: false }, { text: "è¡Œå‹•é›»æº", checked: false }
        ];

        // Default Itinerary Data (For Reset or First Load if DB is empty)
        const defaultItineraryData = {
            day1: {
                title: "å¸‚å€ç¾é£Ÿå·¡ç¦®",
                color: "border-blue-400",
                items: [
                    { type: 'spot', time: '08:00', title: 'å‡ºç™¼ï¼', desc: 'Hostel é›†åˆ', mapQuery: '', category: 'spot' },
                    { type: 'transport', desc: 'ğŸšƒ ç§»å‹•ç´„ 45åˆ†' },
                    { type: 'spot', time: '08:45', title: 'æŸ³æ©‹ä¸­å¤®å¸‚å ´', desc: 'ç”Ÿé­šç‰‡ã€æµ·é®®å·¡ç¦®', mapQuery: 'Yanagibashi Central Market', category: 'food' },
                    { type: 'transport', desc: 'ğŸš¶ é€›è¡—ç´„ 2å°æ™‚+ç§»å‹•15åˆ†' },
                    { type: 'spot', time: '12:00', title: 'é³¥é–‹ç·æœ¬å®¶', desc: 'é‡‘è³è¦ªå­ä¸¼', mapQuery: 'Torikai Sohonke Lucent Tower', category: 'food' },
                    { type: 'transport', desc: 'ğŸšƒ ç§»å‹•ç´„ 15åˆ†' },
                    { type: 'spot', time: '13:30', title: 'å¤§é ˆå•†åº—è¡—', desc: 'é€›è¡—ã€ä¸‹åˆèŒ¶', mapQuery: 'Osu Shopping District', category: 'shop' },
                    { type: 'transport', desc: 'ğŸšƒ ç§»å‹•ç´„ 20åˆ†' },
                    { type: 'spot', time: '15:30', title: 'Konparu (æ¦®)', desc: 'ç‚¸è¦ä¸‰æ˜æ²»(ä¸‹åˆèŒ¶)', mapQuery: 'Konparu Sakae', category: 'food' },
                    { type: 'transport', desc: 'ğŸšƒ ç§»å‹•ç´„ 30åˆ†' },
                    { type: 'spot', time: '18:30', title: 'ç†±ç”°è“¬èŠè»’ (æ™šé¤)', desc: 'å¿…åƒé°»é­šé£¯ä¸‰åƒ Hitsumabushi', mapQuery: 'Atsuta Houraiken Matsuzakaya', category: 'food' }
                ]
            },
            day2: {
                title: "çŠ¬å±±åŸå¤éƒ½éŠ",
                color: "border-pink-400",
                items: [
                    { type: 'spot', time: '07:30', title: 'ä½å®¿åœ°å‡ºç™¼', desc: 'Trip & Sleep Hostel', mapQuery: '', category: 'spot' },
                    { type: 'transport', desc: 'ğŸšƒ ç§»å‹•ç´„ 20åˆ†' },
                    { type: 'spot', time: '08:00', title: 'Bucyo Coffee', desc: 'å°å€‰ç´…è±†åå¸', mapQuery: 'Bucyo Coffee KAKO', category: 'food' },
                    { type: 'transport', desc: 'ğŸšƒ ç§»å‹•ç´„ 45åˆ†' },
                    { type: 'spot', time: '10:00', title: 'çŠ¬å±±åŸ', desc: 'åœ‹å¯¶å¤©å®ˆé–£ (é–€ç¥¨: Â¥550)', mapQuery: 'Inuyama Castle', category: 'spot' },
                    { type: 'transport', desc: 'ğŸš¶ æ•£æ­¥' },
                    { type: 'spot', time: '12:30', title: 'Sakura Chaya', desc: 'ç”°æ¨‚çƒ¤è±†è…ä¸²', mapQuery: 'Sakura Chaya Inuyama', category: 'food' },
                    { type: 'transport', desc: 'ğŸšƒ 13:30 å‡ºç™¼ (è»Šç¨‹ç´„1.5hr)' },
                    { type: 'spot', time: '15:00', title: 'GOLPIE COFFEE', desc: 'å·åå±±å† è»å’–å•¡ (17:00 Close)', mapQuery: 'GOLPIE COFFEE', category: 'food' },
                    { type: 'transport', desc: 'ğŸšƒ ç§»å‹•å›å¤§é ˆç´„ 30åˆ†' },
                    { type: 'spot', time: '18:00', title: 'Solo Pizza Napoletana', desc: 'å¤§é ˆæœ¬åº— (ä¸–ç•Œå† è»æŠ«è–©)', mapQuery: 'Solo Pizza Napoletana Osu', category: 'food' }
                ]
            },
            day3: {
                title: "ååŸèˆ‡è³¼ç‰©",
                color: "border-yellow-400",
                items: [
                    { type: 'spot', time: '07:30', title: 'ä½å®¿åœ°å‡ºç™¼', desc: 'Trip & Sleep Hostel', mapQuery: '', category: 'spot' },
                    { type: 'transport', desc: 'ğŸšƒ ç§»å‹•ç´„ 15åˆ†' },
                    { type: 'spot', time: '08:00', title: 'Karasu', desc: 'å­¤ç¨çš„ç¾é£Ÿå®¶å’–å•¡å»³', mapQuery: 'Coffee Shop Karasu Nagoya', category: 'food' },
                    { type: 'transport', desc: 'ğŸšƒ ç§»å‹•ç´„ 20åˆ†' },
                    { type: 'spot', time: '09:30', title: 'åå¤å±‹åŸ', desc: 'é‡‘é¯±èˆ‡æœ¬ä¸¸å¾¡æ®¿ (é–€ç¥¨: Â¥500)', mapQuery: 'Nagoya Castle', category: 'spot' },
                    { type: 'transport', desc: 'ğŸšŒ ç§»å‹•ç´„ 20åˆ†' },
                    { type: 'spot', time: '11:30', title: 'å¾·å·åœ’', desc: 'æ—¥å¼åº­åœ’æ•£æ­¥ (é–€ç¥¨: Â¥300)', mapQuery: 'Tokugawaen', category: 'spot' },
                    { type: 'transport', desc: 'ğŸšƒ ç§»å‹•ç´„ 30åˆ†' },
                    { type: 'spot', time: '13:00', title: 'Yellow', desc: 'å‰‡æ­¦æ–°ç”º æ¿ƒåšæ­å§†è›‹åŒ…é£¯', mapQuery: 'Yellow Tomato Curried Rice Nagoya', category: 'food' },
                    { type: 'transport', desc: 'ğŸšƒ ç§»å‹•ç´„ 15åˆ†' },
                    { type: 'spot', time: '15:00', title: 'æ¦® (Sakae)', desc: 'LACHIC, ä¸­æ—¥å¤§æ¨“', mapQuery: 'Sakae Nagoya', category: 'shop' },
                    { type: 'transport', desc: 'ğŸšƒ ç§»å‹•ç´„ 10åˆ†' },
                    { type: 'spot', time: '18:00', title: 'æµ·è€ã©ã¦é£Ÿå ‚', desc: '35cm ç‰¹å¤§ç‚¸è¦', mapQuery: 'Ebidote Shokudo', category: 'food' }
                ]
            }
        };

        // If no cache, use default immediately
        if (!itineraryData || Object.keys(itineraryData).length === 0) {
             itineraryData = JSON.parse(JSON.stringify(defaultItineraryData));
        }

        // ================= UI LOGIC =================
        window.onload = function() {
            if (localStorage.getItem('theme') === 'dark') toggleTheme(false);
            
            // Note: Itinerary init is now handled by Firebase script at bottom
            
            switchDay('day1');
            renderExpenses();
            renderChecklist();
            const memoArea = document.getElementById('memo-area');
            if (memoArea) parseMemoLinks(memoArea.value);
            fetchWeather();
            updateCountdown();
            setInterval(updateCountdown, 1000);
            updateSmartStatus();

            // Toggle Input Fields in Modal
            document.getElementById('new-item-type').addEventListener('change', function() {
                if(this.value === 'transport') {
                    document.getElementById('new-item-fields').classList.add('hidden');
                    document.getElementById('new-item-transport-fields').classList.remove('hidden');
                } else {
                    document.getElementById('new-item-fields').classList.remove('hidden');
                    document.getElementById('new-item-transport-fields').classList.add('hidden');
                }
            });
        };

        // Theme Toggle
        function toggleTheme(save = true) {
            const body = document.body;
            const icon = document.getElementById('theme-icon');
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                icon.className = 'fas fa-moon';
                if(save) localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                icon.className = 'fas fa-sun';
                if(save) localStorage.setItem('theme', 'dark');
            }
        }

        function switchPage(pageId) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            window.scrollTo(0,0);
            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
            document.getElementById(pageId.replace('page-', 'nav-')).classList.add('active');
            const iconMap = { 'page-plan': 'fa-plane', 'page-guide': 'fa-book-open', 'page-wallet': 'fa-coins', 'page-lists': 'fa-list-check', 'page-info': 'fa-info' };
            const headerIcon = document.querySelector('#page-title-icon i');
            if (headerIcon) headerIcon.className = `fas ${iconMap[pageId]}`;
        }

        function switchDay(dayId) {
            currentDayId = dayId;
            document.querySelectorAll('.day-tab').forEach(btn => {
                const isActive = btn.id === 'tab-' + dayId;
                btn.className = isActive 
                    ? 'day-tab active bg-white border-2 border-black px-4 py-2 rounded-lg font-bold text-sm whitespace-nowrap shadow-[2px_2px_0_0_#000] flex flex-col items-center justify-center leading-tight min-w-[100px] text-black'
                    : 'day-tab bg-gray-100 border-2 border-transparent px-4 py-2 rounded-lg font-bold text-sm whitespace-nowrap text-gray-500 flex flex-col items-center justify-center leading-tight min-w-[100px]';
            });
            renderItinerary(dayId);
        }

        function renderItinerary(dayId) {
            const contentDiv = document.getElementById('day-content');
            
            // Check if data is loaded
            if (!itineraryData || Object.keys(itineraryData).length === 0) {
                // Keep loading spinner if empty
                return; 
            }

            const data = itineraryData[dayId];
            if (!data) return;

            // --- NEW: Generate Dynamic Google Maps Route Link ---
            const locationItems = data.items.filter(i => i.mapQuery && i.type !== 'transport');
            let googleRouteBtn = '';
            
            if (locationItems.length >= 2) {
                const origin = encodeURIComponent(locationItems[0].mapQuery);
                const destination = encodeURIComponent(locationItems[locationItems.length - 1].mapQuery);
                let waypoints = '';
                
                if (locationItems.length > 2) {
                    const waypointsList = locationItems.slice(1, -1).map(i => encodeURIComponent(i.mapQuery)).join('|');
                    waypoints = `&waypoints=${waypointsList}`;
                }
                
                const mapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}${waypoints}&travelmode=transit`;
                
                googleRouteBtn = `
                    <div class="px-2">
                        <a href="${mapsUrl}" target="_blank" class="block w-full sketch-card p-3 bg-blue-50 hover:bg-blue-100 transition text-center group relative overflow-hidden">
                            <div class="absolute -right-4 -top-4 text-6xl text-blue-200 opacity-20 rotate-12 pointer-events-none group-hover:rotate-0 transition-transform">
                                <i class="fas fa-map-marked-alt"></i>
                            </div>
                            <div class="font-black text-blue-900 text-base flex items-center justify-center gap-2 relative z-10">
                                <i class="fas fa-route"></i> é–‹å•Ÿ Google Maps å°èˆª
                            </div>
                            <div class="text-[10px] text-blue-700 mt-1 font-bold relative z-10">
                                æ ¹æ“šè¡Œç¨‹è‡ªå‹•è¦åŠƒè·¯ç·š ğŸš€
                            </div>
                        </a>
                    </div>
                `;
            }
            // ----------------------------------------------------

            let html = `<div id="${dayId}-detail" class="day-detail">
                <h3 class="font-black text-xl mb-4 border-l-4 ${data.color.replace('border-', 'border-')} pl-3">${data.title}</h3>
                <div class="relative pl-2"><div class="timeline-line"></div>`;

            data.items.forEach((item, index) => {
                const itemId = `card-${dayId}-${index}`;
                if (item.type === 'transport') {
                    html += `<div class="relative flex items-center mb-6 group">
                        <div class="timeline-travel cursor-pointer hover:bg-gray-100" onclick="window.editItem('${dayId}', ${index})">${item.desc}</div>
                        <button onclick="window.deleteItineraryItem('${dayId}', ${index})" class="ml-2 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-trash-alt"></i></button>
                    </div>`;
                } else {
                    // Category Styles
                    let iconBg = 'bg-white';
                    let iconClass = 'fas fa-map-marker-alt';
                    let cardBg = 'sketch-card';
                    
                    if (item.category === 'food') { iconBg = 'bg-yellow-100'; iconClass = 'fas fa-utensils'; }
                    else if (item.category === 'shop') { iconBg = 'bg-red-100'; iconClass = 'fas fa-shopping-bag'; }
                    else if (item.category === 'spot') { iconBg = 'bg-blue-100'; iconClass = 'fas fa-camera'; }
                    
                    const mapLink = item.mapQuery ? 
                        `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.mapQuery)}" target="_blank" class="inline-block text-[10px] bg-white px-2 py-1 rounded border border-gray-300 mt-2 hover:bg-gray-50 text-gray-600"><i class="fas fa-map-marker-alt text-red-500 mr-1"></i>Map</a>` : '';

                    const noteHtml = item.note ? `<div class="note-area mt-2 text-xs text-blue-600 font-bold">ğŸ“ ${item.note}</div>` : '';

                    html += `<div class="relative flex items-start mb-6 group" id="${itemId}">
                        <div class="${iconBg} border-2 border-black w-8 h-8 rounded-full flex items-center justify-center z-10 mr-3 flex-shrink-0"><span class="font-bold text-xs">${item.time ? item.time.replace(':', '') : ''}</span></div>
                        <div class="${cardBg} p-3 flex-1 relative">
                            <div class="absolute top-2 right-2 flex gap-2">
                                <span class="text-gray-300 cursor-pointer hover:text-black" onclick="window.editItem('${dayId}', ${index})"><i class="fas fa-edit"></i></span>
                                <span class="text-gray-300 cursor-pointer hover:text-red-500 opacity-0 group-hover:opacity-100 transition" onclick="window.deleteItineraryItem('${dayId}', ${index})"><i class="fas fa-trash-alt"></i></span>
                            </div>
                            <span class="text-[10px] font-bold bg-gray-100 px-1.5 py-0.5 rounded text-gray-600 mb-1 inline-block"><i class="far fa-clock mr-1"></i>${item.time}</span>
                            <h4 class="font-bold">${item.title}</h4>
                            <p class="text-xs text-gray-500">${item.desc}</p>
                            ${mapLink}
                            ${noteHtml}
                        </div>
                    </div>`;
                }
            });

            // Add Item Button
            html += `<div class="relative flex items-center mb-6 pl-11">
                <button onclick="window.openAddItemModal('${dayId}')" class="text-xs bg-black text-white px-3 py-2 rounded-lg font-bold shadow hover:bg-gray-800 transition"><i class="fas fa-plus mr-1"></i>æ–°å¢è¡Œç¨‹</button>
            </div>`;

            // Inject the dynamic route button here (Moved to bottom)
            html += `<div class="mt-6 mb-20">${googleRouteBtn}</div></div></div>`;

            contentDiv.innerHTML = html;
        }

        // ================= WALLET =================
        let budget = localStorage.getItem('nagoya_budget') || 0;
        document.getElementById('budget-input').value = budget > 0 ? budget : '';
        const calcInput = document.getElementById('calc-input');
        const calcResult = document.getElementById('calc-result');

        function updateBudget() {
            budget = parseFloat(document.getElementById('budget-input').value) || 0;
            localStorage.setItem('nagoya_budget', budget);
            renderExpenses();
        }

        calcInput.addEventListener('input', (e) => {
            try {
                const val = e.target.value.replace(/[^0-9+\-*/.]/g, ''); 
                if(!val) { calcResult.textContent = '0'; return; }
                const res = Function('"use strict";return (' + val + ')')();
                calcResult.textContent = Math.round(res * exchangeRate).toLocaleString();
            } catch(e) {}
        });

        function updateCategoryIcon(select) {
            const icons = { food: 'fa-utensils', shopping: 'fa-shopping-bag', transport: 'fa-train', accommodation: 'fa-bed', other: 'fa-ellipsis-h' };
            document.getElementById('category-icon').className = `fas ${icons[select.value]} text-lg text-black`;
        }
        function updateCurrencySymbol(select) {
            document.getElementById('currency-symbol').textContent = select.value === 'JPY' ? 'Â¥' : '$';
        }

        function addExpense() {
            const desc = document.getElementById('expense-item').value.trim();
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const category = document.getElementById('expense-category').value;
            const currency = document.getElementById('expense-currency').value;
            const photo = document.getElementById('expense-photo-base64').value;
            const isShared = document.getElementById('expense-shared').checked;

            if(!desc || !amount) { alert('è«‹è¼¸å…¥åç¨±èˆ‡é‡‘é¡'); return; }

            let expensesData = JSON.parse(localStorage.getItem('nagoya_expenses_v2')) || { food:[], shopping:[], transport:[], accommodation:[], other:[] };
            if (!expensesData[category]) expensesData[category] = [];
            expensesData[category].push({ desc, amount, currency, photo, isShared, date: new Date().toISOString() });
            localStorage.setItem('nagoya_expenses_v2', JSON.stringify(expensesData));

            // Reset
            document.getElementById('expense-item').value = '';
            document.getElementById('expense-amount').value = '';
            document.getElementById('expense-photo').value = '';
            document.getElementById('expense-photo-base64').value = '';
            document.getElementById('expense-shared').checked = false;
            document.getElementById('photo-label').textContent = "ä¸Šå‚³ç…§ç‰‡";
            document.getElementById('photo-label').classList.remove('text-green-600', 'font-bold');
            renderExpenses();
        }

        function deleteExpense(catId, index) {
            if(confirm('åˆªé™¤æ­¤ç­†ï¼Ÿ')) {
                let expensesData = JSON.parse(localStorage.getItem('nagoya_expenses_v2'));
                expensesData[catId].splice(index, 1);
                localStorage.setItem('nagoya_expenses_v2', JSON.stringify(expensesData));
                renderExpenses();
            }
        }

        function renderExpenses() {
            let expensesData = JSON.parse(localStorage.getItem('nagoya_expenses_v2')) || { food:[], shopping:[], transport:[], accommodation:[], other:[] };
            const container = document.getElementById('expenses-container');
            container.innerHTML = '';
            let totalTWD = 0, totalJPY = 0;
            let catTotals = {};

            expenseCategories.forEach(cat => {
                let catTotalJPY = 0;
                let html = `<div class="sketch-card p-4 ${cat.color}"><div class="flex items-center gap-2 mb-3 border-b-2 border-black pb-2"><i class="fas ${cat.icon} text-xl"></i><h3 class="font-bold text-lg">${cat.name}</h3></div><div class="space-y-2">`;
                
                if(expensesData[cat.id] && expensesData[cat.id].length > 0) {
                    expensesData[cat.id].forEach((item, idx) => {
                        const isJpy = item.currency === 'JPY';
                        const valJpy = isJpy ? item.amount : item.amount / exchangeRate;
                        const valTwd = isJpy ? item.amount * exchangeRate : item.amount;
                        catTotalJPY += valJpy;
                        totalJPY += valJpy;
                        totalTWD += valTwd;

                        html += `<div class="expense-row"><div class="flex items-center gap-2">${item.photo ? '<i class="fas fa-image text-gray-400"></i>' : ''}<span class="font-bold text-sm ${item.isShared ? 'text-green-700':''}">${item.desc} ${item.isShared ? '(å…¬)' : ''}</span></div><div class="flex items-center"><span class="font-black mr-2 text-sm">${isJpy ? 'Â¥' : '$'}${item.amount}</span><i class="fas fa-trash-alt delete-btn text-xs" onclick="deleteExpense('${cat.id}', ${idx})"></i></div></div>`;
                    });
                } else { html += `<div class="text-xs text-gray-400 italic">ç„¡ç´€éŒ„</div>`; }
                html += `</div></div>`;
                catTotals[cat.id] = catTotalJPY;
                container.innerHTML += html;
            });

            document.getElementById('total-jpy').textContent = Math.round(totalJPY).toLocaleString();
            document.getElementById('total-twd').textContent = Math.round(totalTWD).toLocaleString();
            document.getElementById('budget-spent').textContent = Math.round(totalTWD).toLocaleString();

            if (budget > 0) {
                const left = budget - totalTWD;
                document.getElementById('budget-left').textContent = Math.round(left).toLocaleString();
                const pct = Math.min((totalTWD / budget) * 100, 100);
                const bar = document.getElementById('budget-bar');
                bar.style.width = `${pct}%`;
                bar.className = `h-full transition-all duration-500 ${totalTWD > budget ? 'bg-red-500' : 'bg-green-500'}`;
            }
            
            if (totalJPY > 0) {
                let currentAngle = 0;
                let gradientString = '';
                let legendHtml = '';
                
                expenseCategories.forEach((cat) => {
                    const catTotal = catTotals[cat.id] || 0;
                    if (catTotal > 0) {
                        const percent = (catTotal / totalJPY) * 100;
                        const endAngle = currentAngle + percent;
                        gradientString += `${cat.chartColor} ${currentAngle}% ${endAngle}%, `;
                        currentAngle = endAngle;
                        legendHtml += `
                            <div class="flex items-center gap-1">
                                <div class="w-3 h-3 rounded-full" style="background-color: ${cat.chartColor}"></div>
                                <span>${cat.name} (${Math.round(percent)}%)</span>
                            </div>
                        `;
                    }
                });
                gradientString = gradientString.slice(0, -2); 

                const chartSection = document.createElement('div');
                chartSection.innerHTML = `
                    <div class="sketch-card p-4 mt-6 bg-white mb-24 relative overflow-hidden">
                        <h3 class="font-bold text-lg mb-4 text-center border-b-2 border-dashed border-gray-300 pb-2">
                            <i class="fas fa-chart-pie mr-2"></i>æ”¯å‡ºåˆ†ä½ˆ (JPY)
                        </h3>
                        <div class="flex items-center justify-center py-2">
                            <div class="w-40 h-40 rounded-full border-2 border-black shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]" 
                                 style="background: conic-gradient(${gradientString})">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mt-4 text-xs justify-items-center">
                            ${legendHtml}
                        </div>
                    </div>
                `;
                container.appendChild(chartSection);
            }
        }

        function handlePhotoUpload(input) {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const scale = 300 / img.width;
                        canvas.width = 300; canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        document.getElementById('expense-photo-base64').value = canvas.toDataURL('image/jpeg', 0.6);
                        document.getElementById('photo-label').textContent = "å·²é¸";
                        document.getElementById('photo-label').classList.add('text-green-600');
                    }
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // ================= UTILS =================
        function exportData() {
            const data = {
                expenses: JSON.parse(localStorage.getItem('nagoya_expenses_v2')),
                checklist: JSON.parse(localStorage.getItem('nagoya_checklist')),
                itinerary: itineraryData,
                memo: localStorage.getItem('nagoya_memo'),
                budget: localStorage.getItem('nagoya_budget')
            };
            const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'nagoya_backup.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function restoreBackup(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.expenses) localStorage.setItem('nagoya_expenses_v2', JSON.stringify(data.expenses));
                    if(data.checklist) localStorage.setItem('nagoya_checklist', JSON.stringify(data.checklist));
                    // Itinerary restore handled via Firebase manually if needed, or local override?
                    // For now let's assume backup restores local prefs mostly.
                    if(data.memo) localStorage.setItem('nagoya_memo', data.memo);
                    if(data.budget) localStorage.setItem('nagoya_budget', data.budget);
                    alert("å€‹äººè³‡æ–™åŒ¯å…¥æˆåŠŸï¼ç¶²é å°‡é‡æ–°æ•´ç†ã€‚");
                    location.reload();
                } catch(err) {
                    alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤");
                }
            };
            reader.readAsText(file);
        }

        function toggleModal(id) {
            const m = document.getElementById(id);
            m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
        }

        function showTranslation(icon, jp, zh) {
            document.getElementById('trans-icon').textContent = icon;
            document.getElementById('trans-jp').textContent = jp;
            document.getElementById('trans-zh').textContent = zh;
            toggleModal('modal-trans');
        }

        function updateSmartStatus() {
            const now = new Date();
            const start = new Date('2026-03-02');
            const end = new Date('2026-03-06');
            const statusEl = document.getElementById('smart-status');
            
            if (now < start) {
                const diff = Math.ceil((start - now) / (1000 * 60 * 60 * 24));
                statusEl.textContent = `è·é›¢å‡ºç™¼é‚„æœ‰ ${diff} å¤©ï¼`;
            } else if (now >= start && now <= end) {
                statusEl.textContent = "æ—…ç¨‹é€²è¡Œä¸­ âœˆï¸ äº«å—ç•¶ä¸‹ï¼";
                statusEl.classList.add('text-green-600');
            } else {
                statusEl.textContent = "æ—…ç¨‹å·²çµæŸï¼Œæ­¡è¿å›å®¶ ğŸ ";
                statusEl.classList.remove('animate-pulse');
            }
        }

        function updateCountdown() {
            const targetDate = new Date('2026-03-02T16:45:00').getTime();
            const now = new Date().getTime();
            const distance = targetDate - now;
            const el = document.getElementById('countdown-timer');
            if(!el) return;
            if (distance < 0) { el.innerHTML = "æ—…ç¨‹å·²é–‹å§‹ï¼"; return; }
            const d = Math.floor(distance / (1000 * 60 * 60 * 24));
            const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            
            el.innerHTML = `${d}å¤© ${h}æ™‚ ${m}åˆ†`;
        }

        function parseMemoLinks(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const matches = text.match(urlRegex);
            const memoLinks = document.getElementById('memo-links');
            if(memoLinks) {
                memoLinks.innerHTML = '';
                if(matches) {
                    matches.forEach(url => {
                        const a = document.createElement('a');
                        a.href = url; a.target = '_blank';
                        a.className = 'text-[10px] bg-blue-100 text-blue-600 px-2 py-1 rounded truncate max-w-[100px] inline-block border border-blue-200';
                        a.textContent = 'ğŸ”— Link';
                        memoLinks.appendChild(a);
                    });
                }
            }
        }

        const memoArea = document.getElementById('memo-area');
        memoArea.value = localStorage.getItem('nagoya_memo') || '';
        memoArea.addEventListener('input', (e) => { localStorage.setItem('nagoya_memo', e.target.value); });

        async function fetchWeather() {
            try {
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=35.18&longitude=136.90&current_weather=true');
                const data = await res.json();
                const tempEl = document.getElementById('temp-display');
                const descEl = document.getElementById('weather-desc');
                if (tempEl && data.current_weather) {
                    tempEl.textContent = `${data.current_weather.temperature}Â°C`;
                }
                if (descEl) {
                    descEl.textContent = "å³æ™‚æ°£æº«";
                }
            } catch(e) {
                const descEl = document.getElementById('weather-desc');
                if (descEl) {
                    descEl.textContent = "ç„¡æ³•å–å¾—";
                }
            }
        }

        function findNearestHelp() { alert('å®šä½åŠŸèƒ½å•Ÿå‹• (éœ€ HTTPS)'); }

        function renderChecklist() {
            let list = JSON.parse(localStorage.getItem('nagoya_checklist'));
            if(!list || list.length === 0) { 
                list = defaultChecklist; 
                localStorage.setItem('nagoya_checklist', JSON.stringify(list)); 
            }
            const container = document.getElementById('checklist-container');
            container.innerHTML = '';
            list.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2 p-2 border-b border-dashed border-gray-200';
                div.innerHTML = `<input type="checkbox" id="check-${index}" ${item.checked ? 'checked' : ''} class="w-5 h-5 accent-black"><label for="check-${index}" class="flex-1 ${item.checked ? 'line-through text-gray-400' : ''}">${item.text}</label><i class="fas fa-times text-gray-300 cursor-pointer" onclick="removeCheckItem(${index})"></i>`;
                div.querySelector('input').addEventListener('change', (e) => { list[index].checked = e.target.checked; localStorage.setItem('nagoya_checklist', JSON.stringify(list)); renderChecklist(); });
                container.appendChild(div);
            });
        }

        function addCheckItem() { 
            const input = document.getElementById('new-check-item'); 
            if(input.value) { 
                let list = JSON.parse(localStorage.getItem('nagoya_checklist')) || []; 
                list.push({ text: input.value, checked: false }); 
                localStorage.setItem('nagoya_checklist', JSON.stringify(list)); 
                input.value = ''; 
                renderChecklist(); 
            } 
        }

        function removeCheckItem(index) { 
            let list = JSON.parse(localStorage.getItem('nagoya_checklist')); 
            list.splice(index, 1); 
            localStorage.setItem('nagoya_checklist', JSON.stringify(list)); 
            renderChecklist(); 
        }

        function exportCSV() {
            let expensesData = JSON.parse(localStorage.getItem('nagoya_expenses_v2')) || {};
            let csv = '\uFEFFCategory,Description,Amount,Currency,Date\n';
            Object.keys(expensesData).forEach(cat => {
                expensesData[cat].forEach(item => {
                    csv += `${cat},${item.desc},${item.amount},${item.currency},${item.date}\n`;
                });
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "nagoya_expenses.csv";
            link.click();
        }

    </script>

    <!-- Firebase Logic Module -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Auth & Init
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
            
            setupRealtimeListener();
        };
        initAuth();

        const itineraryDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'itinerary', 'shared');

        function setupRealtimeListener() {
            onSnapshot(itineraryDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    // Update global data
                    itineraryData = docSnap.data();
                    // Save to local storage for next time (Cache)
                    localStorage.setItem('nagoya_itinerary_data', JSON.stringify(itineraryData));
                    // Update UI
                    renderItinerary(currentDayId);
                    
                    // Update Status text
                    const statusEl = document.getElementById('smart-status');
                    if(statusEl && statusEl.textContent === 'é€£ç·šä¸­...') {
                         updateSmartStatus(); // Restore normal status
                    }
                } else {
                    // Initialize if empty
                    setDoc(itineraryDocRef, defaultItineraryData);
                }
            }, (error) => {
                console.error("Firebase sync error:", error);
            });
        }

        // --- Expose functions to Window for HTML Buttons ---

        window.openAddItemModal = (dayId) => {
            editingItemIndex = -1; 
            document.getElementById('modal-title').textContent = "æ–°å¢è¡Œç¨‹";
            document.getElementById('btn-save-item').textContent = "æ–°å¢";
            
            document.getElementById('new-item-type').value = 'spot';
            document.getElementById('new-item-time').value = '';
            document.getElementById('new-item-title').value = '';
            document.getElementById('new-item-desc').value = '';
            document.getElementById('new-item-query').value = '';
            document.getElementById('new-item-note').value = '';
            document.getElementById('new-item-trans-desc').value = '';
            
            document.getElementById('new-item-fields').classList.remove('hidden');
            document.getElementById('new-item-transport-fields').classList.add('hidden');
            
            toggleModal('modal-add-item');
        }

        window.editItem = (dayId, index) => {
            editingItemIndex = index;
            const item = itineraryData[dayId].items[index];
            
            document.getElementById('modal-title').textContent = "ç·¨è¼¯è¡Œç¨‹";
            document.getElementById('btn-save-item').textContent = "å„²å­˜ä¿®æ”¹";
            
            document.getElementById('new-item-type').value = item.type;
            
            if (item.type === 'transport') {
                document.getElementById('new-item-trans-desc').value = item.desc;
                document.getElementById('new-item-fields').classList.add('hidden');
                document.getElementById('new-item-transport-fields').classList.remove('hidden');
            } else {
                document.getElementById('new-item-time').value = item.time;
                document.getElementById('new-item-title').value = item.title;
                document.getElementById('new-item-desc').value = item.desc;
                document.getElementById('new-item-query').value = item.mapQuery || '';
                document.getElementById('new-item-note').value = item.note || '';
                
                document.getElementById('new-item-fields').classList.remove('hidden');
                document.getElementById('new-item-transport-fields').classList.add('hidden');
            }
            
            toggleModal('modal-add-item');
        }

        window.saveNewItem = async () => {
            if (!auth.currentUser) return;

            const type = document.getElementById('new-item-type').value;
            let newItem = {};

            if (type === 'transport') {
                const desc = document.getElementById('new-item-trans-desc').value;
                if(!desc) { alert('è«‹è¼¸å…¥ç§»å‹•èªªæ˜'); return; }
                newItem = { type: 'transport', desc: desc };
            } else {
                const time = document.getElementById('new-item-time').value;
                const title = document.getElementById('new-item-title').value;
                const desc = document.getElementById('new-item-desc').value;
                const query = document.getElementById('new-item-query').value;
                const note = document.getElementById('new-item-note').value;
                
                if(!title) { alert('è«‹è¼¸å…¥æ¨™é¡Œ'); return; }
                
                newItem = {
                    type: 'spot',
                    time: time || '00:00',
                    title: title,
                    desc: desc,
                    mapQuery: query,
                    category: type,
                    note: note
                };
            }

            // Create a deep copy to modify
            const newData = JSON.parse(JSON.stringify(itineraryData));

            if (editingItemIndex > -1) {
                newData[currentDayId].items[editingItemIndex] = newItem;
            } else {
                newData[currentDayId].items.push(newItem);
            }

            // Auto Sort Logic
            const items = newData[currentDayId].items;
            let lastTime = "00:00";
            
            const itemsWithSortKey = items.map((item, index) => {
                if (item.time) {
                    lastTime = item.time;
                    return { item, sortTime: item.time, originalIndex: index };
                } else {
                    return { item, sortTime: lastTime + "_99", originalIndex: index };
                }
            });

            itemsWithSortKey.sort((a, b) => {
                if (a.sortTime < b.sortTime) return -1;
                if (a.sortTime > b.sortTime) return 1;
                return a.originalIndex - b.originalIndex;
            });

            newData[currentDayId].items = itemsWithSortKey.map(x => x.item);

            // Save to Firestore
            await setDoc(itineraryDocRef, newData);
            toggleModal('modal-add-item');
        }

        window.deleteItineraryItem = async (dayId, index) => {
            if(!auth.currentUser) return;
            if(confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œç¨‹å—ï¼Ÿ(æ­¤æ“ä½œæœƒåŒæ­¥çµ¦æ‰€æœ‰äºº)')) {
                const newData = JSON.parse(JSON.stringify(itineraryData));
                newData[dayId].items.splice(index, 1);
                await setDoc(itineraryDocRef, newData);
            }
        }

        window.resetItinerary = async () => {
            if(!auth.currentUser) return;
            if(confirm("è­¦å‘Šï¼šç¢ºå®šè¦é‡ç½®ç‚ºé è¨­è¡Œç¨‹å—ï¼Ÿæ‰€æœ‰äººçš„è®Šæ›´éƒ½æœƒæ¶ˆå¤±ï¼")) {
                await setDoc(itineraryDocRef, defaultItineraryData);
            }
        }

    </script>
</body>
</html>